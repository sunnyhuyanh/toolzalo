<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu√©t nh√≥m Zalo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --primary:#0084ff; --primary-dark:#0071e3; }
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#e8f1ff 0%,#f7fbff 100%);
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" stroke="%23666" viewBox="0 0 24 24" fill="none"%3E%3Cpath d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
      background-repeat:no-repeat;
      background-position:right .7rem center;
      background-size:1rem;
    }
    .login-bg {
      background: linear-gradient(135deg, #0084ff 0%, #0066cc 50%, #004499 100%);
    }
    .zalo-logo {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(0, 132, 255, 0.3);
    }
    .feature-card {
      transition: all 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 132, 255, 0.15);
    }
    @media (max-width: 640px) {
      .main-container { padding: 1rem 0.75rem; max-height: none; }
      .card { margin: 0; border-radius: 1rem; padding: 1.5rem; max-width: 100%; }
      textarea { resize: vertical; min-height: 100px; }
      #groupList, #groupList2 { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem; }
      #groupList::-webkit-scrollbar, #groupList2::-webkit-scrollbar { width: 4px; }
      #groupList::-webkit-scrollbar-track, #groupList2::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
      #groupList::-webkit-scrollbar-thumb, #groupList2::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
      #groupList::-webkit-scrollbar-thumb:hover, #groupList2::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    }
    .shake { animation: shake 0.5s ease-in-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body class="min-h-screen relative">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-bg min-h-screen flex items-center justify-center py-4 px-4">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 space-y-8">
      <div class="text-center space-y-4">
        <div class="flex justify-center">
          <div class="zalo-logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path d="M16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2zm0 25.2c-6.174 0-11.2-5.026-11.2-11.2S9.826 4.8 16 4.8 27.2 9.826 27.2 16 22.174 27.2 16 27.2z" fill="#0084ff"/>
              <path d="M22.4 14.933c0-.746-.746-1.493-1.493-1.493h-2.24V11.2c0-.746-.746-1.493-1.493-1.493s-1.493.747-1.493 1.493v2.24h-2.24c-.746 0-1.493.747-1.493 1.493s.747 1.493 1.493 1.493h2.24v2.24c0 .746.746 1.493 1.493 1.493s1.493-.747 1.493-1.493v-2.24h2.24c.747 0 1.493-.747 1.493-1.493z" fill="#0084ff"/>
            </svg>
          </div>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h1>
          <p class="text-sm text-gray-600 mt-1">Qu√©t nh√≥m Zalo t·ª± ƒë·ªông</p>
        </div>
      </div>
      <form id="loginForm" class="space-y-6">
        <div class="space-y-4">
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
            <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
            <div class="relative">
              <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required />
              <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <svg id="eyeOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <svg id="eyeClosed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
          <p class="text-sm text-red-600 text-center">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</p>
        </div>
        <button type="submit" id="loginBtn" class="w-full bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-3 rounded-lg transition-all disabled:opacity-60 touch-manipulation">
          <span id="loginBtnText">ƒêƒÉng nh·∫≠p</span>
          <svg id="loginSpinner" class="hidden animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
          </svg>
        </button>
      </form>
      <div class="text-center pt-4 border-t border-gray-100">
        <p class="text-xs text-gray-400">Developed by Hailinhmacduc</p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <div class="fixed top-4 right-4 z-40 flex gap-2">
      <button id="homeBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
        </svg>
        Trang ch·ªß
      </button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
        ƒêƒÉng xu·∫•t
      </button>
    </div>

<div class="main-container min-h-screen flex items-center justify-center py-4 px-4 sm:py-10">

      <!-- Overlay loader + message -->
      <div id="overlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 text-center px-6">
        <svg id="overlaySpinner" class="animate-spin h-10 w-10 text-[var(--primary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p id="overlayText" class="mt-3 text-sm text-gray-700">ƒêang x·ª≠ l√Ω...</p>
      </div>

      <!-- TRANG CH·ª¶ - CH·ªåN T√çNH NƒÇNG -->
      <div id="homePage" class="card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-8">
        <header class="text-center space-y-2">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-wide uppercase">H·ªá th·ªëng qu√©t nh√≥m Zalo</h1>
          <p class="text-sm text-gray-500">Qu√©t &amp; g·ª≠i tin nh·∫Øn cho th√†nh vi√™n nh√≥m Zalo nhanh ch√≥ng</p>
          <p class="text-xs text-amber-600 font-medium">***L∆∞u √Ω: m·ªói 1 nick 1 ng√†y g·ª≠i t·ªëi ƒëa 40 ng∆∞·ªùi</p>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
          <!-- T√≠nh nƒÉng 1: G·ª≠i tin nh·∫Øn cho th√†nh vi√™n -->
          <div id="feature1Card" class="feature-card bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-blue-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-blue-900">G·ª≠i tin nh·∫Øn</h3>
              <p class="text-sm text-blue-700">G·ª≠i tin nh·∫Øn cho th√†nh vi√™n trong nh√≥m</p>
            </div>
          </div>

          <!-- T√≠nh nƒÉng 2: ƒêƒÉng b√†i t·ª± ƒë·ªông -->
          <div id="feature2Card" class="feature-card bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-green-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-green-900">ƒêƒÉng b√†i t·ª± ƒë·ªông</h3>
              <p class="text-sm text-green-700">ƒêƒÉng b√†i cho t·∫•t c·∫£ c√°c nh√≥m ƒë∆∞·ª£c ch·ªçn</p>
            </div>
          </div>

          <!-- T√≠nh nƒÉng 3: M·ªùi th√†nh vi√™n -->
          <div id="feature3Card" class="feature-card bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-purple-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-purple-900">M·ªùi th√†nh vi√™n</h3>
              <p class="text-sm text-purple-700">M·ªùi th√†nh vi√™n v√†o nh√≥m</p>
            </div>
          </div>
        </div>

        <!-- T√°c gi·∫£ -->
        <div class="text-center pt-4 border-t border-gray-100">
          <p class="text-xs text-gray-400">Developed by Hailinhmacduc</p>
        </div>
      </div>

      <!-- T√çNH NƒÇNG 1: G·ª¨I TIN NH·∫ÆN CHO TH√ÄNH VI√äN -->
      <div id="feature1Page" class="hidden">
        <!-- STEP 1 -->
        <div id="step1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">G·ª≠i tin nh·∫Øn cho th√†nh vi√™n</h1>
            <p class="text-sm text-gray-500">Qu√©t nh√≥m v√† g·ª≠i tin nh·∫Øn cho th√†nh vi√™n</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect" class="text-sm font-medium text-gray-600">Ch·ªçn t√†i kho·∫£n (nick) c·∫ßn qu√©t nh√≥m</label>
            <div class="relative">
              <select id="nickSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary">
                <option value="" disabled selected hidden>Ch·ªçn m·ªôt nick ‚Ä¶</option>
                <option value="test">test</option>
                <option value="D∆∞∆°ng Nguy·ªÖn">D∆∞∆°ng Nguy·ªÖn</option>
                <option value="ƒê·ª©c Ph√≤ng">ƒê·ª©c Ph√≤ng</option>
              </select>
            </div>
          </div>

          <button id="scanBtn" class="w-full flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-3 rounded-lg transition disabled:opacity-60 touch-manipulation">
            <span>Qu√©t nh√≥m</span>
            <svg id="spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">K·∫øt qu·∫£</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <ul id="groupList" class="list-decimal list-inside space-y-1 text-gray-700 text-sm"></ul>
                <p id="emptyMsg" class="text-gray-400 italic text-sm">Kh√¥ng t√¨m th·∫•y nh√≥m n√†o</p>
              </div>
            </div>
            <div id="actionsBox" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <label for="groupSelect" class="block text-sm font-medium text-gray-600">Ch·ªçn nh√≥m ƒë·ªÉ g·ª≠i tin nh·∫Øn</label>
              <select id="groupSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary"></select>
              <button id="nextBtn" class="w-full flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Ti·∫øp t·ª•c</button>
            </div>
          </section>
        </div>
<!-- STEP 2 -->
        <div id="step2" class="hidden card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">G·ª≠i tin nh·∫Øn t·ªõi nh√≥m</h2>
            <p id="chosenGroup" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-4">
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung c·∫ßn g·ª≠i <span class="text-red-500">*</span></label>
              <textarea id="message" rows="4" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary resize-vertical" placeholder="Nh·∫≠p n·ªôi dung tin nh·∫Øn..."></textarea>
            </div>

            <div>
              <label for="images" class="block text-sm font-medium text-gray-700 mb-1">T·∫£i ·∫£nh l√™n (t·ªëi ƒëa 3 ·∫£nh)</label>
              <input id="images" type="file" accept="image/*" multiple class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" />
              
              <div id="imageStatus" class="mt-2 text-sm hidden">
                <div id="imageCountSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageCountText"></span>
                </div>
                <div id="imageCountWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageWarningText"></span>
                </div>
                <div id="imageCountError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageErrorText"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay l·∫°i</button>
            <button id="sendMsgBtn" class="flex-1 flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
              <span>G·ª≠i tin nh·∫Øn</span>
              <svg id="spinnerSend" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- T√çNH NƒÇNG 2: ƒêƒÇNG B√ÄI T·ª∞ ƒê·ªòNG -->
      <div id="feature2Page" class="hidden">
        <!-- STEP 1: QU√âT NH√ìM -->
        <div id="step2_1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">ƒêƒÉng b√†i t·ª± ƒë·ªông</h1>
            <p class="text-sm text-gray-500">Qu√©t nh√≥m v√† ch·ªçn nh√≥m ƒë·ªÉ ƒëƒÉng b√†i</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect2" class="text-sm font-medium text-gray-600">Ch·ªçn t√†i kho·∫£n (nick) c·∫ßn qu√©t nh√≥m</label>
            <div class="relative">
              <select id="nickSelect2" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary">
                <option value="" disabled selected hidden>Ch·ªçn m·ªôt nick ‚Ä¶</option>
                <option value="test">test</option>
                <option value="D∆∞∆°ng Nguy·ªÖn">D∆∞∆°ng Nguy·ªÖn</option>
                <option value="ƒê·ª©c Ph√≤ng">ƒê·ª©c Ph√≤ng</option>
              </select>
            </div>
          </div>

          <button id="scanBtn2" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-60 touch-manipulation">
            <span>Qu√©t nh√≥m</span>
            <svg id="spinner2" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection2" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">K·∫øt qu·∫£ qu√©t nh√≥m</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <div id="groupListContainer2" class="space-y-3">
                  <div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg border border-green-200">
                    <input type="checkbox" id="selectAllGroups" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="selectAllGroups" class="text-sm font-medium text-green-800">Ch·ªçn t·∫•t c·∫£ nh√≥m</label>
                  </div>
                  
                  <div id="groupList2" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
                <p id="emptyMsg2" class="text-gray-400 italic text-sm">Kh√¥ng t√¨m th·∫•y nh√≥m n√†o</p>
              </div>
            </div>
            <div id="actionsBox2" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <div id="selectedGroupsInfo" class="text-sm text-gray-600">
                <span id="selectedCount">0</span> nh√≥m ƒë∆∞·ª£c ch·ªçn
              </div>
              <button id="nextBtn2" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Ti·∫øp t·ª•c</button>
            </div>
          </section>
        </div>
<!-- STEP 2: SO·∫†N N·ªòI DUNG -->
        <div id="step2_2" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">So·∫°n n·ªôi dung ƒëƒÉng b√†i</h2>
            <p id="selectedGroupsDisplay" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-6">
            <div>
              <label for="postContent" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                  </svg>
                  N·ªôi dung b√†i vi·∫øt
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <textarea 
                id="postContent" 
                rows="6" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 resize-vertical" 
                placeholder="B·∫°n ƒëang nghƒ© g√¨...?"
                required
              ></textarea>
              <div class="mt-1 text-xs text-gray-500">
                <span id="charCount">0</span> k√Ω t·ª±
              </div>
            </div>

            <div>
              <label for="postImages" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                  </svg>
                  T·∫£i ·∫£nh l√™n
                  <span class="text-red-500">* (B·∫Øt bu·ªôc 4 ·∫£nh)</span>
                </span>
              </label>
              <input 
                id="postImages" 
                type="file" 
                accept="image/*" 
                multiple 
                class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" 
                required
              />
              
              <div id="postImageStatus" class="mt-2 text-sm hidden">
                <div id="postImageSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageSuccessText"></span>
                </div>
                <div id="postImageWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageWarningText"></span>
                </div>
                <div id="postImageError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageErrorText"></span>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  H·∫πn gi·ªù ƒëƒÉng b√†i (t√πy ch·ªçn)
                </span>
              </label>
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableSchedule" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                <label for="enableSchedule" class="text-sm text-gray-600">B·∫≠t h·∫πn gi·ªù ƒëƒÉng b√†i</label>
              </div>
              
              <div id="scheduleInputs" class="hidden mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="scheduleDate" class="block text-xs font-medium text-gray-600 mb-1">Ng√†y</label>
                  <input 
                    type="date" 
                    id="scheduleDate" 
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                  />
                </div>
                <div>
                  <label for="scheduleTime" class="block text-xs font-medium text-gray-600 mb-1">Gi·ªù</label>
                  <input 
                    type="time" 
                    id="scheduleTime" 
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn2" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay l·∫°i</button>
            <button id="publishBtn" class="flex-1 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
              <span>ƒêƒÉng b√†i</span>
              <svg id="publishSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- T√çNH NƒÇNG 3: M·ªúI TH√ÄNH VI√äN -->
      <div id="feature3Page" class="hidden card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
        <header class="text-center space-y-1">
          <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">M·ªùi th√†nh vi√™n v√†o nh√≥m</h1>
          <p class="text-sm text-gray-500">M·ªùi th√†nh vi√™n v√†o nh√≥m Zalo</p>
        </header>

        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <p class="text-sm text-amber-800 text-center">üöß T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn</p>
        </div>
      </div>

    </div>
  </div>

  <!-- SCRIPT -->
  <script>
const scanWebhook = 'https://primary-production-55bc0.up.railway.app/webhook/zalo-automation';
    const sendWebhook = 'https://primary-production-55bc0.up.railway.app/webhook/zalo-sent-text-image';

    const ADMIN_USERNAME = 'Admin';
    const ADMIN_PASSWORD = 'nguyenduc139@';

    const $ = id => document.getElementById(id);
    const toggle = (el, show) => el.classList[show ? 'remove' : 'add']('hidden');

    // Elements
    const loginPage = $('loginPage');
    const mainApp = $('mainApp');
    const loginForm = $('loginForm');
    const loginError = $('loginError');
    const loginBtn = $('loginBtn');
    const loginBtnText = $('loginBtnText');
    const loginSpinner = $('loginSpinner');
    const logoutBtn = $('logoutBtn');
    const homeBtn = $('homeBtn');
    const togglePassword = $('togglePassword');
    const passwordInput = $('password');
    const eyeOpen = $('eyeOpen');
    const eyeClosed = $('eyeClosed');

    // Pages
    const homePage = $('homePage');
    const feature1Page = $('feature1Page');
    const feature2Page = $('feature2Page');
    const feature3Page = $('feature3Page');
    
    // Feature 2 elements
    const step2_1 = $('step2_1');
    const step2_2 = $('step2_2');
    const nickSelect2 = $('nickSelect2');
    const scanBtn2 = $('scanBtn2');
    const spinner2 = $('spinner2');
    const resultSection2 = $('resultSection2');
    const groupList2 = $('groupList2');
    const emptyMsg2 = $('emptyMsg2');
    const actionsBox2 = $('actionsBox2');
    const selectAllGroups = $('selectAllGroups');
    const selectedCount = $('selectedCount');
    const nextBtn2 = $('nextBtn2');
    const backBtn2 = $('backBtn2');
    const selectedGroupsDisplay = $('selectedGroupsDisplay');
    
    // Post content elements
    const postContent = $('postContent');
    const postImages = $('postImages');
    const enableSchedule = $('enableSchedule');
    const scheduleInputs = $('scheduleInputs');
    const scheduleDate = $('scheduleDate');
    const scheduleTime = $('scheduleTime');
    const publishBtn = $('publishBtn');
    const publishSpinner = $('publishSpinner');
    const charCount = $('charCount');
    
    // Post image status elements
    const postImageStatus = $('postImageStatus');
    const postImageSuccess = $('postImageSuccess');
    const postImageWarning = $('postImageWarning');
    const postImageError = $('postImageError');
    const postImageSuccessText = $('postImageSuccessText');
    const postImageWarningText = $('postImageWarningText');
    const postImageErrorText = $('postImageErrorText');

    // Feature cards
    const feature1Card = $('feature1Card');
    const feature2Card = $('feature2Card');
    const feature3Card = $('feature3Card');

    const overlay = $('overlay');
    const overlayText = $('overlayText');
    const step1 = $('step1');
    const step2 = $('step2');

    const nickSelect = $('nickSelect');
    const scanBtn = $('scanBtn');
    const spinner = $('spinner');
    const resultSec = $('resultSection');
    const groupList = $('groupList');
    const emptyMsg = $('emptyMsg');
    const actionsBox = $('actionsBox');
    const groupSelect = $('groupSelect');
    const nextBtn = $('nextBtn');

    const backBtn = $('backBtn');
    const sendMsgBtn = $('sendMsgBtn');
    const spinnerSend = $('spinnerSend');
    const messageTxt = $('message');
    const imagesInput = $('images');
    const chosenGroup = $('chosenGroup');
    
    // Elements cho th√¥ng b√°o ·∫£nh
    const imageStatus = $('imageStatus');
    const imageCountSuccess = $('imageCountSuccess');
    const imageCountWarning = $('imageCountWarning');
    const imageCountError = $('imageCountError');
    const imageCountText = $('imageCountText');
    const imageWarningText = $('imageWarningText');
    const imageErrorText = $('imageErrorText');

    let currentGroup = { id: '', name: '' };
    let selectedGroups = [];

    // H√†m hi·ªÉn th·ªã trang
    function showPage(pageToShow) {
      toggle(homePage, false);
      toggle(feature1Page, false);
      toggle(feature2Page, false);
      toggle(feature3Page, false);
      toggle(pageToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // H√†m hi·ªÉn th·ªã step cho feature 2
    function showFeature2Step(stepToShow) {
      toggle(step2_1, false);
      toggle(step2_2, false);
      toggle(stepToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // H√†m ki·ªÉm tra s·ªë l∆∞·ª£ng ·∫£nh cho tin nh·∫Øn
    function checkImageCount() {
      const fileCount = imagesInput.files.length;
      toggle(imageCountSuccess, false);
      toggle(imageCountWarning, false);
      toggle(imageCountError, false);
      
      if (fileCount === 0) {
        toggle(imageStatus, false);
        return;
      }
      
      toggle(imageStatus, true);
      
      if (fileCount === 3) {
        toggle(imageCountSuccess, true);
        imageCountText.textContent = "ƒê√£ t·∫£i ƒë·ªß 3 ·∫£nh - Ho√†n h·∫£o!";
      } else if (fileCount < 3) {
        toggle(imageCountWarning, true);
        imageWarningText.textContent = `ƒê√£ t·∫£i ${fileCount} ·∫£nh. H√£y t·∫£i th√™m ${3 - fileCount} ·∫£nh n·ªØa ƒë·ªÉ ƒë·ªß 3 ·∫£nh.`;
      } else {
        toggle(imageCountError, true);
        imageErrorText.textContent = `ƒê√£ t·∫£i ${fileCount} ·∫£nh. Vui l√≤ng x√≥a b·ªõt ${fileCount - 3} ·∫£nh ho·∫∑c t·∫£i l·∫°i ƒë·ªÉ ƒë·ªß 3 ·∫£nh.`;
      }
    }
    
    // H√†m ki·ªÉm tra s·ªë l∆∞·ª£ng ·∫£nh cho ƒëƒÉng b√†i
    function checkPostImageCount() {
      const fileCount = postImages.files.length;
      toggle(postImageSuccess, false);
      toggle(postImageWarning, false);
      toggle(postImageError, false);
      
      if (fileCount === 0) {
        toggle(postImageStatus, false);
        return;
      }
      
      toggle(postImageStatus, true);
      
      if (fileCount === 4) {
        toggle(postImageSuccess, true);
        postImageSuccessText.textContent = "ƒê√£ t·∫£i ƒë·ªß 4 ·∫£nh - Ho√†n h·∫£o!";
      } else if (fileCount < 4) {
        toggle(postImageWarning, true);
        postImageWarningText.textContent = `ƒê√£ t·∫£i ${fileCount} ·∫£nh. C·∫ßn t·∫£i th√™m ${4 - fileCount} ·∫£nh n·ªØa ƒë·ªÉ ƒë·ªß 4 ·∫£nh.`;
      } else {
        toggle(postImageError, true);
        postImageErrorText.textContent = `ƒê√£ t·∫£i ${fileCount} ·∫£nh. Vui l√≤ng x√≥a b·ªõt ${fileCount - 4} ·∫£nh ho·∫∑c t·∫£i l·∫°i ƒë·ªÉ ƒë·ªß 4 ·∫£nh.`;
      }
    }
    
    // H√†m c·∫≠p nh·∫≠t s·ªë k√Ω t·ª±
    function updateCharCount() {
      const count = postContent.value.length;
      charCount.textContent = count;
      charCount.className = count > 1000 ? 'text-red-500' : 'text-gray-500';
    }
    
    // H√†m c·∫≠p nh·∫≠t s·ªë nh√≥m ƒë∆∞·ª£c ch·ªçn
    function updateSelectedGroupsCount() {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]:checked');
      selectedCount.textContent = checkboxes.length;
      nextBtn2.disabled = checkboxes.length === 0;
      
      selectedGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
    }
    
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng v·ªõi t√≠ch xanh
    function showSuccessMessage(message) {
      overlayText.innerHTML = `
        <div class="flex flex-col items-center gap-3">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
          </div>
          <p class="text-green-600 font-medium">${message}</p>
        </div>
      `;
    }

    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi load trang
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('zalo_scanner_logged_in');
      if (isLoggedIn === 'true') {
        showMainApp();
      } else {
        showLoginPage();
      }
    }

    function showLoginPage() {
      toggle(loginPage, true);
      toggle(mainApp, false);
    }

    function showMainApp() {
      toggle(loginPage, false);
      toggle(mainApp, true);
      showPage(homePage);
    }
// Event listeners cho c√°c t√≠nh nƒÉng
    feature1Card.addEventListener('click', () => {
      showPage(feature1Page);
    });

    feature2Card.addEventListener('click', () => {
      showPage(feature2Page);
      showFeature2Step(step2_1);
    });

    feature3Card.addEventListener('click', () => {
      showPage(feature3Page);
    });

    // N√∫t Home
    homeBtn.addEventListener('click', () => {
      showPage(homePage);
      toggle(step1, true);
      toggle(step2, false);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      nickSelect.selectedIndex = 0;
      messageTxt.value = '';
      imagesInput.value = '';
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';
      checkImageCount();
      
      showFeature2Step(step2_1);
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      nickSelect2.selectedIndex = 0;
      postContent.value = '';
      postImages.value = '';
      groupList2.innerHTML = '';
      selectedGroups = [];
      enableSchedule.checked = false;
      toggle(scheduleInputs, false);
      updateCharCount();
      checkPostImageCount();
    });

    // Event listener cho input file
    imagesInput.addEventListener('change', checkImageCount);
    postImages.addEventListener('change', checkPostImageCount);
    
    // Event listener cho textarea
    postContent.addEventListener('input', updateCharCount);
    
    // Event listener cho h·∫πn gi·ªù
    enableSchedule.addEventListener('change', () => {
      if (enableSchedule.checked) {
        toggle(scheduleInputs, true);
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        scheduleDate.value = tomorrow.toISOString().split('T')[0];
        scheduleTime.value = '09:00';
      } else {
        toggle(scheduleInputs, false);
      }
    });
    
    // Event listener cho select all
    selectAllGroups.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = selectAllGroups.checked);
      updateSelectedGroupsCount();
    });

    // Toggle hi·ªÉn th·ªã m·∫≠t kh·∫©u
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      
      if (type === 'text') {
        toggle(eyeOpen, false);
        toggle(eyeClosed, true);
      } else {
        toggle(eyeOpen, true);
        toggle(eyeClosed, false);
      }
    });

    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = $('username').value.trim();
      const password = $('password').value;

      loginBtn.disabled = true;
      toggle(loginBtnText, false);
      toggle(loginSpinner, true);
      toggle(loginError, false);

      await new Promise(resolve => setTimeout(resolve, 1000));

      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        sessionStorage.setItem('zalo_scanner_logged_in', 'true');
        showMainApp();
        loginForm.reset();
      } else {
        toggle(loginError, true);
        loginForm.classList.add('shake');
        setTimeout(() => loginForm.classList.remove('shake'), 500);
      }

      loginBtn.disabled = false;
      toggle(loginBtnText, true);
      toggle(loginSpinner, false);
    });

    // ƒêƒÉng xu·∫•t
    logoutBtn.addEventListener('click', () => {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        sessionStorage.removeItem('zalo_scanner_logged_in');
        showLoginPage();
        showPage(homePage);
        toggle(step1, true);
        toggle(step2, false);
        toggle(resultSec, false);
        toggle(actionsBox, false);
        nickSelect.selectedIndex = 0;
        messageTxt.value = '';
        imagesInput.value = '';
        groupList.innerHTML = '';
        groupSelect.innerHTML = '';
        checkImageCount();
      }
    });

    // NgƒÉn zoom khi double tap tr√™n iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // ---- FEATURE 1: Qu√©t nh√≥m ----
    scanBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      if (!nick) return alert('Vui l√≤ng ch·ªçn m·ªôt nick.');

      scanBtn.disabled = true;
      toggle(spinner, true);
      overlayText.innerHTML = 'ƒêang qu√©t nh√≥m, vui l√≤ng ch·ªù...';
      toggle(overlay, true);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';

      try {
        const res = await fetch(scanWebhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nick }) });
        if (!res.ok) throw new Error('Network error');
        const raw = await res.json();

        let groups = [];
        if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ id: i.groupId || i.groupid || i.id, name: i.name || i.groupName || 'Kh√¥ng t√™n' }));
        } else if (raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => typeof g === 'string' ? { id: g, name: g } : { id: g.id || g.groupId, name: g.name || g.groupName || g.id });
        }

        if (groups.length === 0) {
          toggle(emptyMsg, true);
        } else {
          toggle(emptyMsg, false);
          groups.forEach(g => {
            groupList.insertAdjacentHTML('beforeend', `<li class="break-words">${g.name}</li>`);
            groupSelect.insertAdjacentHTML('beforeend', `<option value="${g.id}">${g.name}</option>`);
          });
          toggle(actionsBox, true);
        }
        toggle(resultSec, true);
      } catch (err) {
        console.error(err);
        alert('Qu√©t nh√≥m th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
      } finally {
        scanBtn.disabled = false;
        toggle(spinner, false);
        toggle(overlay, false);
      }
    });

    // ---- FEATURE 1: Chuy·ªÉn sang b∆∞·ªõc 2 ----
    nextBtn.addEventListener('click', () => {
      const groupId = groupSelect.value;
      if (!groupId) return alert('Vui l√≤ng ch·ªçn m·ªôt nh√≥m.');
      currentGroup = { id: groupId, name: groupSelect.options[groupSelect.selectedIndex].text };
      chosenGroup.textContent = `S·∫Ω g·ª≠i ƒë·∫øn: ${currentGroup.name}`;
      toggle(step1, false);
      toggle(step2, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- FEATURE 1: Quay l·∫°i ----
    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggle(step2, false);
      toggle(step1, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- FEATURE 1: G·ª≠i tin nh·∫Øn ----
    sendMsgBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      const text = messageTxt.value.trim();
      const files = imagesInput.files;
      if (!text) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung.');
      if (files.length > 3) return alert('Ch·ªâ t·∫£i t·ªëi ƒëa 3 ·∫£nh.');

      sendMsgBtn.disabled = true;
      toggle(spinnerSend, true);
      overlayText.innerHTML = 'ƒêang ti·∫øn h√†nh g·ª≠i tin nh·∫Øn, vui l√≤ng ch·ªù...';
      toggle(overlay, true);

      try {
        const formData = new FormData();
        formData.append('nick', nick);
        formData.append('groupId', currentGroup.id);
        formData.append('groupName', currentGroup.name);
        formData.append('text', text);
        Array.from(files).forEach((f, idx) => formData.append('image' + (idx + 1), f));

        const res = await fetch(sendWebhook, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Send error');
        await res.json();

        showSuccessMessage('ƒê√£ g·ª≠i tin nh·∫Øn th√†nh c√¥ng!');
        messageTxt.value = '';
        imagesInput.value = '';
        checkImageCount();

        setTimeout(() => {
          toggle(overlay, false);
          toggle(step2, false);
          toggle(step1, true);
          overlayText.innerHTML = 'ƒêang x·ª≠ l√Ω...';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 3000);
      } catch (err) {
        console.error(err);
        alert('G·ª≠i tin nh·∫Øn th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
        toggle(overlay, false);
      } finally {
        sendMsgBtn.disabled = false;
        toggle(spinnerSend, false);
      }
    });
// ---- FEATURE 2: Qu√©t nh√≥m cho ƒëƒÉng b√†i ----
    scanBtn2.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      if (!nick) return alert('Vui l√≤ng ch·ªçn m·ªôt nick.');

      scanBtn2.disabled = true;
      toggle(spinner2, true);
      overlayText.innerHTML = 'ƒêang qu√©t nh√≥m, vui l√≤ng ch·ªù...';
      toggle(overlay, true);
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      groupList2.innerHTML = '';
      selectedGroups = [];

      try {
        const res = await fetch(scanWebhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nick }) });
        if (!res.ok) throw new Error('Network error');
        const raw = await res.json();

        let groups = [];
        if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ id: i.groupId || i.groupid || i.id, name: i.name || i.groupName || 'Kh√¥ng t√™n' }));
        } else if (raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => typeof g === 'string' ? { id: g, name: g } : { id: g.id || g.groupId, name: g.name || g.groupName || g.id });
        }

        if (groups.length === 0) {
          toggle(emptyMsg2, true);
        } else {
          toggle(emptyMsg2, false);
          groups.forEach((g, index) => {
            groupList2.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateSelectedGroupsCount()"
                >
                <label for="group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
          toggle(actionsBox2, true);
        }
        toggle(resultSection2, true);
        updateSelectedGroupsCount();
      } catch (err) {
        console.error(err);
        alert('Qu√©t nh√≥m th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
      } finally {
        scanBtn2.disabled = false;
        toggle(spinner2, false);
        toggle(overlay, false);
      }
    });

    // ---- FEATURE 2: Chuy·ªÉn sang so·∫°n n·ªôi dung ----
    nextBtn2.addEventListener('click', () => {
      if (selectedGroups.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m.');
      
      const groupNames = selectedGroups.map(g => g.name).join(', ');
      selectedGroupsDisplay.textContent = `S·∫Ω ƒëƒÉng b√†i v√†o ${selectedGroups.length} nh√≥m: ${groupNames}`;
      showFeature2Step(step2_2);
    });

    // ---- FEATURE 2: Quay l·∫°i ----
    backBtn2.addEventListener('click', () => {
      showFeature2Step(step2_1);
    });

    // ---- FEATURE 2: ƒêƒÉng b√†i ----
    publishBtn.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      const text = postContent.value.trim();
      const files = postImages.files;
      
      if (!text) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt.');
      if (files.length !== 4) return alert('Vui l√≤ng t·∫£i ƒë√∫ng 4 ·∫£nh.');
      if (selectedGroups.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m.');

      let scheduleData = null;
      if (enableSchedule.checked) {
        if (!scheduleDate.value || !scheduleTime.value) {
          return alert('Vui l√≤ng ch·ªçn ng√†y v√† gi·ªù h·∫πn ƒëƒÉng b√†i.');
        }
        scheduleData = {
          date: scheduleDate.value,
          time: scheduleTime.value
        };
      }

      publishBtn.disabled = true;
      toggle(publishSpinner, true);
      overlayText.innerHTML = 'ƒêang ti·∫øn h√†nh ƒëƒÉng b√†i, vui l√≤ng ch·ªù...';
      toggle(overlay, true);

      try {
        const formData = new FormData();
        formData.append('nick', nick);
        formData.append('text', text);
        formData.append('groups', JSON.stringify(selectedGroups));
        
        Array.from(files).forEach((f, idx) => {
          formData.append('image' + (idx + 1), f);
        });
        
        if (scheduleData) {
          formData.append('schedule', JSON.stringify(scheduleData));
        }

        const res = await fetch('https://primary-production-55bc0.up.railway.app/webhook/zalo-post-group', { 
          method: 'POST', 
          body: formData 
        });
        
        if (!res.ok) throw new Error('Post error');
        await res.json();

        showSuccessMessage('ƒê√£ ƒëƒÉng b√†i th√†nh c√¥ng!');
        
        postContent.value = '';
        postImages.value = '';
        enableSchedule.checked = false;
        toggle(scheduleInputs, false);
        updateCharCount();
        checkPostImageCount();

        setTimeout(() => {
          toggle(overlay, false);
          showFeature2Step(step2_1);
          overlayText.innerHTML = 'ƒêang x·ª≠ l√Ω...';
        }, 3000);
      } catch (err) {
        console.error(err);
        alert('ƒêƒÉng b√†i th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
        toggle(overlay, false);
      } finally {
        publishBtn.disabled = false;
        toggle(publishSpinner, false);
      }
    });

    // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
    checkAuth();
    
    // ƒê·∫£m b·∫£o updateSelectedGroupsCount c√≥ th·ªÉ truy c·∫≠p global
    window.updateSelectedGroupsCount = updateSelectedGroupsCount;
    
    // Kh·ªüi t·∫°o c√°c gi√° tr·ªã ban ƒë·∫ßu
    updateCharCount();
    checkImageCount();
    checkPostImageCount();
  </script>
</body>
</html>
