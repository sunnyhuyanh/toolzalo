<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quét nhóm Zalo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Configuration -->
  <script src="config.js"></script>
  <!-- Supabase Service -->
  <script src="supabase-service.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root { 
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #8b5cf6;
      --accent: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --light: #f8fafc;
    }
    
    * {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    *::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    *::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 8px;
    }
    
    *::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #3b82f6, #8b5cf6);
      border-radius: 8px;
    }
    
    *::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #2563eb, #7c3aed);
    }
    
    body{
      font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 80%, transparent 50%, rgba(255, 255, 255, 0.1) 50.5%),
        radial-gradient(circle at 80% 20%, transparent 50%, rgba(255, 255, 255, 0.1) 50.5%),
        radial-gradient(circle at 40% 40%, transparent 50%, rgba(255, 255, 255, 0.05) 50.5%);
      background-size: 100px 100px, 150px 150px, 200px 200px;
      animation: bgAnimation 20s ease infinite;
      z-index: -1;
      pointer-events: none;
    }
    
    @keyframes bgAnimation {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(-20px, -20px) rotate(1deg); }
      66% { transform: translate(20px, -20px) rotate(-1deg); }
    }
    
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" stroke="%236366f1" viewBox="0 0 24 24" fill="none"%3E%3Cpath d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
      background-repeat:no-repeat;
      background-position:right .7rem center;
      background-size:1rem;
      transition: all 0.3s ease;
    }
    
    select:hover {
      border-color: var(--primary);
    }
    
    select:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    
    .glass-dark {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }
    
    .gradient-border {
      position: relative;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(135deg, #667eea 0%, #764ba2 100%) border-box;
      border: 2px solid transparent;
    }
    
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .pulse-dot {
      position: relative;
    }
    
    .pulse-dot::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      background: inherit;
      border-radius: inherit;
      animation: pulse 2s ease infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }
    
    .feature-card {
      position: relative;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
    }
    
    .feature-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, transparent 40%, rgba(255, 255, 255, 0.3));
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    .feature-card:hover {
      transform: translateY(-8px) rotateX(5deg) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 
                  0 15px 12px rgba(0, 0, 0, 0.08),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .feature-card:hover::before {
      opacity: 1;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: var(--primary);
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .input-group {
      position: relative;
    }
    
    .input-group input,
    .input-group textarea,
    .input-group select {
      transition: all 0.3s ease;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
    }
    
    .input-group input:focus,
    .input-group textarea:focus,
    .input-group select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    @media (max-width: 640px) {
      .main-container { padding: 1rem 0.75rem; max-height: none; }
      .card { margin: 0; border-radius: 1.5rem; padding: 1.5rem; max-width: 100%; }
      textarea { resize: vertical; min-height: 100px; }
      #groupList, #groupList2 { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem; }
    }
    
    .shake { 
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-up {
      animation: slideUp 0.4s ease forwards;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5),
                  0 0 40px rgba(139, 92, 246, 0.3),
                  0 0 60px rgba(236, 72, 153, 0.2);
    }
  </style>
</head>
<body class="min-h-screen relative">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center py-4 px-4">
    <!-- Background decorations -->
    <div class="absolute inset-0 overflow-hidden">
      <div class="absolute -top-40 -right-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-white/5 rounded-full blur-3xl"></div>
    </div>
    
    <div class="relative w-full max-w-md glass rounded-3xl p-8 space-y-8 fade-in">
      <div class="text-center space-y-6">
        <div class="flex justify-center">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl shadow-lg flex items-center justify-center transform hover:scale-110 transition-transform duration-300 floating pulse-dot">
            <!-- Zalo Logo SVG -->
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
              <!-- Z letter stylized -->
              <path d="M14 12h20v4l-12 12h12v4H14v-4l12-12H14z" fill="white"/>
              <!-- Chat bubble -->
              <path d="M36 24c0 6.627-5.373 12-12 12-2.765 0-5.315-.935-7.35-2.508L12 36l2.508-4.65C12.935 29.315 12 26.765 12 24c0-6.627 5.373-12 12-12s12 5.373 12 12z" stroke="white" stroke-width="2" fill="none"/>
              <!-- Small decorative dots -->
              <circle cx="20" cy="24" r="1.5" fill="white"/>
              <circle cx="24" cy="24" r="1.5" fill="white"/>
              <circle cx="28" cy="24" r="1.5" fill="white"/>
            </svg>
          </div>
        </div>
        <div class="space-y-2">
          <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">
            Zalo Auto Pro
          </h1>
          <p class="text-gray-600 font-medium">Hệ thống quản lý nhóm thông minh</p>
          <div class="flex items-center justify-center gap-2 text-sm text-blue-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>Bảo mật & Tin cậy</span>
          </div>
        </div>
      </div>
      <form id="loginForm" class="space-y-6">
        <div class="space-y-5">
          <div class="space-y-2">
            <label for="username" class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
              <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
              </svg>
              Tên đăng nhập
            </label>
            <div class="relative">
              <input type="text" id="username" name="username" required autofocus
                class="w-full bg-gray-50/50 border border-gray-200 rounded-xl px-4 py-3 pl-11 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-gray-800"
                placeholder="Nhập tên đăng nhập..."/>
              <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="space-y-2">
            <label for="password" class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
              <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
              </svg>
              Mật khẩu
            </label>
            <div class="relative">
              <input type="password" id="password" name="password" required
                class="w-full bg-gray-50/50 border border-gray-200 rounded-xl px-4 py-3 pl-11 pr-12 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-gray-800"
                placeholder="Nhập mật khẩu..."/>
              <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                </svg>
              </div>
              <!-- Icon show/hide password -->
              <button type="button" id="togglePassword"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none transition-colors">
                <span id="eyeOpen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-width="2" d="M1.5 12C3.5 7.5 7.5 4.5 12 4.5s8.5 3 10.5 7.5c-2 4.5-6 7.5-10.5 7.5s-8.5-3-10.5-7.5z"></path>
                    <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
                  </svg>
                </span>
                <span id="eyeClosed" class="hidden">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-width="2" d="M17.94 17.94A10.06 10.06 0 0 1 12 19.5C7.5 19.5 3.5 16.5 1.5 12c.928-2.088 2.262-3.97 3.94-5.44M6.34 6.34A10.06 10.06 0 0 1 12 4.5c4.5 0 8.5 3 10.5 7.5a9.978 9.978 0 0 1-4.73 5.61M1 1l22 22"></path>
                  </svg>
                </span>
              </button>
            </div>
          </div>
        </div>
        
        <div id="loginError" class="hidden bg-red-50/80 border border-red-200 rounded-xl p-4 backdrop-blur-sm">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm text-red-700 font-medium">Tên đăng nhập hoặc mật khẩu không đúng!</p>
          </div>
        </div>
        
        <button type="submit" id="loginBtn" class="w-full btn-primary font-bold py-4 rounded-xl transition-all duration-200 disabled:opacity-60 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl touch-manipulation">
          <span id="loginBtnText" class="flex items-center justify-center gap-3">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="text-lg">Đăng nhập hệ thống</span>
          </span>
          <svg id="loginSpinner" class="hidden animate-spin h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
          </svg>
        </button>
      </form>
      </form>
      
      <div class="space-y-4">
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-4 bg-white text-gray-500 font-medium">Tính năng nổi bật</span>
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="p-3 bg-blue-50/50 rounded-lg">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
              <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
              </svg>
            </div>
            <p class="text-xs font-medium text-blue-700">Gửi tin nhắn</p>
          </div>
          
          <div class="p-3 bg-green-50/50 rounded-lg">
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
              <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-xs font-medium text-green-700">Đăng bài</p>
          </div>
          
          <div class="p-3 bg-purple-50/50 rounded-lg">
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
              <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
              </svg>
            </div>
            <p class="text-xs font-medium text-purple-700">Mời thành viên</p>
          </div>
        </div>
      </div>
      
      <div class="text-center pt-4 border-t border-gray-100/50">
        <div class="flex items-center justify-center gap-2 text-xs text-gray-500">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414L10 11.414l1.293 1.293a1 1 0 01-1.414 1.414L10 13.414l-1.293 1.293a1 1 0 01-1.414-1.414L8.586 12 7.293 10.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span>Developed by <strong class="text-gray-700">Hailinhmacduc</strong></span>
        </div>
        <p class="text-xs text-gray-400 mt-1">© 2025 Zalo Auto Pro. All rights reserved.</p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden">
      <!-- Header -->
  <div class="fixed top-4 right-4 z-40 flex gap-2">
    <button id="homeBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
      </svg>
      Trang chủ
    </button>
    <button id="adminBtn" class="hidden bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
      </svg>
      Admin Panel
    </button>
    <button id="logoutBtn" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 shadow-md hover:shadow-lg">
      Đăng xuất
    </button>
  </div>

<div class="main-container min-h-screen flex items-center justify-center py-4 px-4 sm:py-10">

      <!-- Overlay loader + message -->
      <div id="overlay" class="hidden fixed inset-0 bg-gradient-to-br from-black/50 via-purple-900/30 to-black/50 backdrop-blur-md flex flex-col items-center justify-center z-50 text-center px-6">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-8 shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" style="animation: scaleIn 0.3s ease forwards;">
          <div class="relative">
            <div class="w-16 h-16 mx-auto mb-4 relative">
              <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full animate-ping"></div>
              <div class="relative bg-gradient-to-r from-blue-500 to-purple-600 rounded-full w-16 h-16 flex items-center justify-center">
                <svg id="overlaySpinner" class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
              </div>
            </div>
            <p id="overlayText" class="text-lg font-semibold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Đang xử lý...</p>
            <div class="mt-3 flex justify-center gap-1">
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
              <span class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
              <span class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        @keyframes scaleIn {
          to {
            transform: scale(1);
            opacity: 1;
          }
        }
      </style>

      <!-- TRANG CHỦ - DASHBOARD -->
      <div id="homePage" class="card w-full max-w-5xl glass rounded-3xl overflow-hidden fade-in">
        <!-- Header với lời chào -->
        <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 px-6 sm:px-10 py-8 text-white relative overflow-hidden">
          <div class="absolute inset-0 opacity-20">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white rounded-full blur-2xl"></div>
            <div class="absolute -bottom-10 -left-10 w-60 h-60 bg-white rounded-full blur-3xl"></div>
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="space-y-2">
              <h1 id="welcomeGreeting" class="text-2xl sm:text-3xl font-bold">
                Xin chào, <span id="userDisplayName" class="text-yellow-300">Người dùng</span>! 👋
              </h1>
              <p class="text-blue-100 text-sm sm:text-base">
                Chúc bạn có một ngày làm việc hiệu quả với Zalo Automation
              </p>
              <div class="flex items-center gap-4 text-xs sm:text-sm text-blue-200">
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                  </svg>
                  <span id="currentDate">Thứ hai, 31/07/2025</span>
                </div>
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  <span id="currentTime">14:30</span>
                </div>
              </div>
            </div>
            
            <!-- User Avatar & Info -->
            <div class="flex items-center gap-3 glass-dark backdrop-blur-xl rounded-xl px-4 py-3 relative z-10">
              <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                <span id="userInitials">U</span>
              </div>
              <div class="text-right hidden sm:block">
                <p class="font-semibold text-sm" id="userFullName">User Name</p>
                <p class="text-xs text-blue-200">
                  <span id="userNickCount">0</span> Nick Zalo
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="px-6 sm:px-10 py-6 bg-gradient-to-br from-gray-50 to-gray-100">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 hover:-translate-y-1 cursor-pointer group">
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <p class="text-xl font-bold text-gray-900">0</p>
              <p class="text-xs text-gray-500">Tin nhắn hôm nay</p>
            </div>
            
            <div class="text-center p-4 bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 hover:-translate-y-1 cursor-pointer group">
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
              </div>
              <p class="text-xl font-bold text-gray-900">0</p>
              <p class="text-xs text-gray-500">Bài đăng hôm nay</p>
            </div>
            
            <div class="text-center p-4 bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 hover:-translate-y-1 cursor-pointer group">
              <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
              </div>
              <p class="text-xl font-bold text-gray-900">0</p>
              <p class="text-xs text-gray-500">Thành viên mời</p>
            </div>
            
            <div class="text-center p-4 bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 hover:-translate-y-1 cursor-pointer group">
              <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <svg class="w-4 h-4 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                </svg>
              </div>
              <p class="text-xl font-bold text-gray-900" id="userNickCountStat">0</p>
              <p class="text-xs text-gray-500">Nick Zalo</p>
            </div>
          </div>
        </div>
        <!-- Main Features -->
        <div class="px-6 sm:px-10 py-8 space-y-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-900">Chọn tính năng</h2>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <!-- Tính năng 1: Gửi tin nhắn cho thành viên -->
            <div id="feature1Card" class="feature-card group relative bg-gradient-to-br from-blue-50 via-blue-100 to-indigo-100 border-2 border-transparent bg-clip-padding rounded-2xl p-6 cursor-pointer text-center space-y-4 transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 overflow-hidden">
              <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-indigo-500 opacity-0 group-hover:opacity-10 transition-opacity duration-300 rounded-2xl"></div>
              <div class="relative z-10 w-16 h-16 mx-auto bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-300 group-hover:scale-110 group-hover:rotate-3">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                </svg>
              </div>
              <div class="relative z-10">
                <h3 class="text-lg font-bold bg-gradient-to-r from-blue-700 to-indigo-700 bg-clip-text text-transparent">Gửi tin nhắn</h3>
                <p class="text-sm text-gray-600 mt-1">Gửi tin nhắn cho từng thành viên trong nhóm</p>
              </div>
            </div>

            <!-- Tính năng 2: Đăng bài tự động -->
            <div id="feature2Card" class="feature-card group relative bg-gradient-to-br from-green-50 via-green-100 to-emerald-100 border-2 border-transparent bg-clip-padding rounded-2xl p-6 cursor-pointer text-center space-y-4 transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 overflow-hidden">
              <div class="absolute inset-0 bg-gradient-to-br from-green-400 to-emerald-500 opacity-0 group-hover:opacity-10 transition-opacity duration-300 rounded-2xl"></div>
              <div class="relative z-10 w-16 h-16 mx-auto bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-300 group-hover:scale-110 group-hover:rotate-3">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="relative z-10">
                <h3 class="text-lg font-bold bg-gradient-to-r from-green-700 to-emerald-700 bg-clip-text text-transparent">Đăng bài tự động</h3>
                <p class="text-sm text-gray-600 mt-1">Tự động Đăng bài cho tất cả các nhóm được chọn</p>
              </div>
            </div>

            <!-- Tính năng 3: Mời thành viên -->
            <div id="feature3Card" class="feature-card group relative bg-gradient-to-br from-purple-50 via-purple-100 to-pink-100 border-2 border-transparent bg-clip-padding rounded-2xl p-6 cursor-pointer text-center space-y-4 transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 overflow-hidden">
              <div class="absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-500 opacity-0 group-hover:opacity-10 transition-opacity duration-300 rounded-2xl"></div>
              <div class="relative z-10 w-16 h-16 mx-auto bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-300 group-hover:scale-110 group-hover:rotate-3">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
              </div>
              <div class="relative z-10">
                <h3 class="text-lg font-bold bg-gradient-to-r from-purple-700 to-pink-700 bg-clip-text text-transparent">Mời thành viên</h3>
                <p class="text-sm text-gray-600 mt-1">Mời thành viên vào nhóm</p>
              </div>
            </div>
          </div>

          <!-- Tác giả -->
          <div class="text-center pt-6 border-t border-gray-100">
            <div class="flex items-center justify-center gap-2 text-xs text-gray-500 mb-2">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              <span>Developed by <strong class="text-gray-700">SUNNYdev</strong></span>
            </div>
            <p class="text-xs text-gray-400">© 2025 Zalo Auto Pro. All rights reserved.</p>
          </div>
        </div>
      </div>

      <!-- TÍNH NĂNG 1: GỬI TIN NHẮN CHO THÀNH VIÊN -->
      <div id="feature1Page" class="hidden">
        <!-- STEP 1 -->
        <div id="step1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Gửi tin nhắn cho thành viên</h1>
            <p class="text-sm text-gray-500">Quét nhóm và gửi tin nhắn cho thành viên</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition-all duration-300 hover:border-gray-300 bg-white">
                <option value="" disabled selected hidden>Chọn một nick …</option>
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
                <option value="Khánh Duy">Khánh Duy</option>
              </select>
            </div>
          </div>

          <!-- Cache info display -->
          <div id="cacheInfo1" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 flex-1">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span id="cacheText1" class="text-sm text-blue-700 font-medium"></span>
              </div>
              <button id="refreshBtn1" class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 hover:text-blue-800 transition-all duration-200 text-sm font-medium rounded-md border border-blue-300 hover:border-blue-400 flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Quét lại
              </button>
            </div>
          </div>

          <button id="scanBtn" class="w-full flex items-center justify-center gap-2 btn-primary font-semibold py-3 rounded-xl transition-all duration-300 disabled:opacity-60 touch-manipulation hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl">
            <span>Quét nhóm</span>
            <svg id="spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">Kết quả</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <ul id="groupList" class="list-decimal list-inside space-y-1 text-gray-700 text-sm"></ul>
                <p id="emptyMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
              </div>
            </div>
            <div id="actionsBox" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <label for="groupSelect" class="block text-sm font-medium text-gray-600">Chọn nhóm để gửi tin nhắn</label>
              <select id="groupSelect" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition-all duration-300 hover:border-gray-300 bg-white"></select>
              <button id="nextBtn" class="w-full flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>
<!-- STEP 2 -->
        <div id="step2" class="hidden card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Gửi tin nhắn tới nhóm</h2>
            <p id="chosenGroup" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-4">
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Nội dung cần gửi <span class="text-red-500">*</span></label>
              <textarea id="message" rows="4" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition-all duration-300 resize-vertical hover:border-gray-300" placeholder="Nhập nội dung tin nhắn..."></textarea>
            </div>

            <div>
              <label for="images" class="block text-sm font-medium text-gray-700 mb-1">Tải ảnh lên (tối đa 3 ảnh)</label>
              <input id="images" type="file" accept="image/*" multiple class="w-full text-sm border-2 border-gray-200 rounded-xl px-3 py-2 transition-all duration-300 focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-100 file:mr-3 file:py-1 file:px-3 file:rounded-lg file:border-0 file:text-sm file:bg-gradient-to-r file:from-blue-500 file:to-purple-600 file:text-white hover:file:from-blue-600 hover:file:to-purple-700 file:transition-all file:duration-300 file:cursor-pointer" />
              
              <div id="imageStatus" class="mt-2 text-sm hidden">
                <div id="imageCountSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageCountText"></span>
                </div>
                <div id="imageCountWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageWarningText"></span>
                </div>
                <div id="imageCountError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageErrorText"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
            <button id="sendMsgBtn" class="flex-1 flex items-center justify-center gap-2 btn-primary font-semibold py-2.5 rounded-xl transition-all duration-300 disabled:opacity-60 touch-manipulation hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl">
              <span>Gửi tin nhắn</span>
              <svg id="spinnerSend" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- TÍNH NĂNG 2: ĐĂNG BÀI TỰ ĐỘNG -->
      <div id="feature2Page" class="hidden">
        <!-- STEP 1: QUÉT NHÓM -->
        <div id="step2_1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Đăng bài tự động</h1>
            <p class="text-sm text-gray-500">Quét nhóm và chọn nhóm để đăng bài</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect2" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect2" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition-all duration-300 hover:border-gray-300 bg-white">
                <option value="" disabled selected hidden>Chọn một nick …</option>
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
                <option value="Khánh Duy">Khánh Duy</option>
              </select>
            </div>
          </div>

          <!-- Cache info display -->
          <div id="cacheInfo2" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 flex-1">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span id="cacheText2" class="text-sm text-blue-700 font-medium"></span>
              </div>
              <button id="refreshBtn2" class="flex items-center gap-1 px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 hover:text-green-800 transition-all duration-200 text-sm font-medium rounded-md border border-green-300 hover:border-green-400 flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Quét lại
              </button>
            </div>
          </div>

          <button id="scanBtn2" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 rounded-xl transition-all duration-300 disabled:opacity-60 touch-manipulation hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl">
            <span>Quét nhóm</span>
            <svg id="spinner2" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection2" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">Kết quả quét nhóm</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <div id="groupListContainer2" class="space-y-3">
                  <div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg border border-green-200">
                    <input type="checkbox" id="selectAllGroups" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="selectAllGroups" class="text-sm font-medium text-green-800">Chọn tất cả nhóm</label>
                  </div>
                  
                  <div id="groupList2" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
                <p id="emptyMsg2" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
              </div>
            </div>
            <div id="actionsBox2" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <div id="selectedGroupsInfo" class="text-sm text-gray-600">
                <span id="selectedCount">0</span> nhóm được chọn
              </div>
              <button id="nextBtn2" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>

        <!-- STEP 1.5: CHỌN LOẠI BÀI ĐĂNG -->
        <div id="step2_1_5" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-3">
            <div class="w-20 h-20 mx-auto bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-wide">Chọn loại bài đăng</h2>
            <p class="text-base text-gray-600 max-w-md mx-auto">Bạn muốn tạo bài viết mới hay sử dụng lại bài viết đã lưu?</p>
            <div id="selectedGroupsDisplay2" class="inline-flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
              </svg>
              <span id="selectedGroupsText2"></span>
            </div>
          </header>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Tạo bài mới -->
            <div id="createNewPostCard" class="group cursor-pointer bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-2xl p-8 text-center space-y-6 hover:shadow-xl hover:scale-105 transition-all duration-300 hover:border-blue-300">
              <div class="w-20 h-20 mx-auto bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="space-y-3">
                <h3 class="text-xl font-bold text-blue-900 group-hover:text-blue-800 transition-colors">Tạo bài viết mới</h3>
                <p class="text-sm text-blue-700 leading-relaxed">Soạn nội dung mới, tải ảnh và thiết lập lịch đăng bài hoàn toàn mới</p>
                <div class="flex items-center justify-center gap-2 text-xs text-blue-600 font-medium">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                  <span>Tùy chỉnh hoàn toàn</span>
                </div>
              </div>
            </div>

            <!-- Sử dụng bài cũ -->
            <div id="useOldPostCard" class="group cursor-pointer bg-gradient-to-br from-purple-50 to-pink-100 border-2 border-purple-200 rounded-2xl p-8 text-center space-y-6 hover:shadow-xl hover:scale-105 transition-all duration-300 hover:border-purple-300">
              <div class="w-20 h-20 mx-auto bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
                  <path d="M10.5 2A1.5 1.5 0 0012 3.5v11a3.5 3.5 0 11-7 0V6.5a1.5 1.5 0 013 0V14a.5.5 0 001 0V3.5A1.5 1.5 0 0110.5 2z"/>
                </svg>
              </div>
              <div class="space-y-3">
                <div class="flex items-center justify-center gap-2">
                  <h3 class="text-xl font-bold text-purple-900 group-hover:text-purple-800 transition-colors">Sử dụng bài cũ</h3>
                  <span id="oldPostCount" class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-1 rounded-full">0</span>
                </div>
                <p class="text-sm text-purple-700 leading-relaxed">Chọn từ các bài viết đã lưu trước đó để đăng lại nhanh chóng</p>
                <div class="flex items-center justify-center gap-2 text-xs text-purple-600 font-medium">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  <span>Tiết kiệm thời gian</span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button id="backToGroupSelection" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition touch-manipulation">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
              </svg>
              Quay lại
            </button>
          </div>
        </div>

        <!-- MODAL: CHỌN BÀI CŨ -->
        <div id="oldPostModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0" style="animation: modalOpen 0.3s ease-out forwards;">
            <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 px-6 py-5 relative overflow-hidden">
              <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
              <div class="relative flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
                      <path d="M10.5 2A1.5 1.5 0 0012 3.5v11a3.5 3.5 0 11-7 0V6.5a1.5 1.5 0 013 0V14a.5.5 0 001 0V3.5A1.5 1.5 0 0110.5 2z"/>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-2xl font-bold text-white mb-1">Thư viện bài viết</h3>
                    <p class="text-white/80 text-sm">Chọn bài viết đã lưu để đăng lại</p>
                  </div>
                </div>
                <button id="closeOldPostModal" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center transition-all duration-200 backdrop-blur-sm hover:scale-105">
                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="p-8 bg-gradient-to-br from-gray-50 to-gray-100">
              <div id="oldPostsList" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <div id="noOldPosts" class="col-span-full text-center py-16 text-gray-500">
                  <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
                      <path d="M10.5 2A1.5 1.5 0 0012 3.5v11a3.5 3.5 0 11-7 0V6.5a1.5 1.5 0 013 0V14a.5.5 0 001 0V3.5A1.5 1.5 0 0110.5 2z"/>
                    </svg>
                  </div>
                  <h4 class="text-xl font-semibold text-gray-600 mb-3">Chưa có bài viết nào</h4>
                  <p class="text-gray-500 max-w-md mx-auto">Các bài viết đã tạo sẽ được lưu tự động và hiển thị ở đây để bạn có thể sử dụng lại</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <style>
          @keyframes modalOpen {
            from {
              opacity: 0;
              transform: scale(0.9) translateY(-20px);
            }
            to {
              opacity: 1;
              transform: scale(1) translateY(0);
            }
          }
          
          .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
          }
          
          .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
          }
          
          .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #cbd5e1, #94a3b8);
            border-radius: 4px;
          }
          
          .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #94a3b8, #64748b);
          }
          
          .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }
        </style>

        <!-- MODAL: XEM TRƯỚC BÀI VIẾT -->
        <div id="previewModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div class="bg-gray-100 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden" style="max-width: 400px;">
            <!-- Header giống Zalo -->
            <div class="bg-white px-4 py-3 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                  <span class="text-white font-bold text-sm">A</span>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900 text-sm">anh Thanh nguyên Đức</h4>
                  <p class="text-xs text-gray-500">12:01</p>
                </div>
              </div>
              <button id="closePreviewModal" class="w-8 h-8 hover:bg-gray-100 rounded-lg flex items-center justify-center transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
            
            <div class="bg-white overflow-y-auto max-h-[calc(90vh-160px)]">
              <!-- Nội dung bài viết -->
              <div class="p-4">
                <div id="previewContent" class="text-gray-800 mb-3 leading-relaxed whitespace-pre-wrap text-sm"></div>
                
                <!-- Grid ảnh giống Zalo -->
                <div id="previewImages" class="grid gap-1 rounded-lg overflow-hidden"></div>
              </div>
              
              <!-- Action buttons giống Zalo -->
              <div class="px-4 py-3 border-t border-gray-100">
                <div class="flex items-center justify-around">
                  <button class="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors py-2 px-3 rounded-lg hover:bg-gray-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    <span class="text-sm font-medium">Thích</span>
                  </button>
                  <button class="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors py-2 px-3 rounded-lg hover:bg-gray-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="text-sm font-medium">Bình luận</span>
                  </button>
                  <button class="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors py-2 px-3 rounded-lg hover:bg-gray-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                    </svg>
                    <span class="text-sm font-medium">Chia sẻ</span>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Bottom action buttons -->
            <div class="bg-white border-t border-gray-200 p-4 flex gap-3">
              <button id="selectThisPost" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-all text-sm">
                Chọn bài viết này
              </button>
              <button id="cancelPreview" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-all text-sm">
                Hủy
              </button>
            </div>
          </div>
        </div>

        <!-- STEP 2: SOẠN NỘI DUNG -->
        <div id="step2_2" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Soạn nội dung đăng bài</h2>
            <p id="selectedGroupsDisplay" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-6">
            <div>
              <label for="postContent" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                  </svg>
                  Nội dung bài viết
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <textarea 
                id="postContent" 
                rows="6" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 resize-vertical" 
                placeholder="Bạn đang nghĩ gì...?"
                required
              ></textarea>
              <div class="mt-1 text-xs text-gray-500">
                <span id="charCount">0</span> ký tự
              </div>
            </div>

            <div>
              <label for="postImages" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                  </svg>
                  Tải ảnh lên
                  <span class="text-red-500">* (Bắt buộc 4 ảnh)</span>
                </span>
              </label>
              <input 
                id="postImages" 
                type="file" 
                accept="image/*" 
                multiple 
                class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" 
                required
              />
              
              <div id="postImageStatus" class="mt-2 text-sm hidden">
                <div id="postImageSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageSuccessText"></span>
                </div>
                <div id="postImageWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageWarningText"></span>
                </div>
                <div id="postImageError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageErrorText"></span>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  Hẹn giờ đăng bài (tùy chọn)
                </span>
              </label>
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableSchedule" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                <label for="enableSchedule" class="text-sm text-gray-600">Bật hẹn giờ đăng bài</label>
              </div>
              
              <div id="scheduleInputs" class="hidden mt-3 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Chế độ lên lịch</label>
                    <select id="scheduleMode" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 hover:border-gray-300 bg-white">
                      <option value="once">Đăng một lần</option>
                      <option value="weekly">Đăng theo tuần (lặp lại)</option>
                    </select>
                  </div>
                  <div id="selectedDaysCount" class="hidden">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Số ngày đã chọn</label>
                    <div class="text-sm text-purple-600 font-medium py-2">
                      <span id="selectedDaysText">0 ngày</span>
                    </div>
                  </div>
                </div>
                
                <!-- Đăng một lần -->
                <div id="onceModeInputs" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label for="scheduleDate" class="block text-xs font-medium text-gray-600 mb-1">Ngày</label>
                    <input 
                      type="date" 
                      id="scheduleDate" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                  <div>
                    <label for="scheduleTime" class="block text-xs font-medium text-gray-600 mb-1">Giờ</label>
                    <input 
                      type="time" 
                      id="scheduleTime" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                </div>
                
                <!-- Đăng theo tuần -->
                <div id="weeklyModeInputs" class="hidden space-y-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-2">Chọn các ngày trong tuần</label>
                    <div class="space-y-2">
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_1" value="1" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_1" class="text-sm text-gray-700 flex-1">Thứ 2</label>
                        <input type="time" id="time_1" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_2" value="2" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_2" class="text-sm text-gray-700 flex-1">Thứ 3</label>
                        <input type="time" id="time_2" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_3" value="3" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_3" class="text-sm text-gray-700 flex-1">Thứ 4</label>
                        <input type="time" id="time_3" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_4" value="4" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_4" class="text-sm text-gray-700 flex-1">Thứ 5</label>
                        <input type="time" id="time_4" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_5" value="5" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_5" class="text-sm text-gray-700 flex-1">Thứ 6</label>
                        <input type="time" id="time_5" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_6" value="6" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_6" class="text-sm text-gray-700 flex-1">Thứ 7</label>
                        <input type="time" id="time_6" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                      <div class="flex items-center gap-3 p-2 border rounded-lg hover:bg-gray-50">
                        <input type="checkbox" id="day_0" value="0" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 day-checkbox">
                        <label for="day_0" class="text-sm text-gray-700 flex-1">Chủ nhật</label>
                        <input type="time" id="time_0" class="border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-500 focus:outline-none transition-all duration-300 day-time hover:border-gray-300" disabled>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn2" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
            <button id="publishBtn" class="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-2.5 rounded-xl transition-all duration-300 disabled:opacity-60 touch-manipulation hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl">
              <span>Đăng bài</span>
              <svg id="publishSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>

        <!-- STEP 3: DANH SÁCH BÀI ĐĂNG ĐÃ LÊN LỊCH -->
        <div id="step2_3" class="hidden card w-full max-w-4xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-3">
            <div class="w-20 h-20 mx-auto bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mb-4 animate-pulse">
              <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-2xl sm:text-3xl font-extrabold text-green-600 tracking-wide">🎉 Lên lịch thành công!</h2>
            <p class="text-base text-gray-600 max-w-md mx-auto">Bài viết của bạn đã được lên lịch và sẵn sàng đăng tự động</p>
            <div class="inline-flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              Hệ thống sẽ tự động đăng bài theo lịch
            </div>
          </header>

          <div class="space-y-6">
            <!-- Thông tin bài vừa lên lịch -->
            <div id="newScheduledPost" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6 shadow-sm">
              <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center gap-3">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                </div>
                Bài viết vừa lên lịch
              </h3>
              <div id="newPostDetails" class="text-sm text-green-700 space-y-2 bg-white rounded-lg p-4 border border-green-100">
                <!-- Thông tin sẽ được thêm bằng JavaScript -->
              </div>
            </div>

            <!-- Danh sách tất cả bài đăng đã lên lịch -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                </svg>
                Danh sách bài đăng đã lên lịch
                <span id="scheduledPostsCount" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
              </h3>
              
              <div id="scheduledPostsList" class="space-y-4 max-h-96 overflow-y-auto">
                <div id="noScheduledPosts" class="text-center py-12 text-gray-500">
                  <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <h4 class="text-lg font-medium text-gray-600 mb-2">Chưa có bài đăng nào</h4>
                  <p class="text-sm text-gray-500">Bài đăng tương lai sẽ hiển thị ở đây</p>
                </div>
              </div>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <button id="scheduleNewPostBtn" class="flex-1 flex items-center justify-center gap-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg hover:shadow-xl touch-manipulation">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
              </svg>
              <span class="text-lg">Lên lịch bài mới</span>
            </button>
            <button id="backToHomeBtn" class="flex-1 flex items-center justify-center gap-3 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-md hover:shadow-lg touch-manipulation">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
              </svg>
              <span class="text-lg">Về trang chủ</span>
            </button>
          </div>
        </div>
      </div>

      <!-- TÍNH NĂNG 3: MỜI THÀNH VIÊN -->
      <div id="feature3Page" class="hidden">
        <!-- STEP 1: QUÉT NHÓM -->
        <div id="step3_1" class="card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Mời thành viên vào nhóm</h1>
            <p class="text-sm text-gray-500">Quét nhóm và chọn thành viên để mời vào nhóm khác</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect3" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect3" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-purple-500">
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
                <option value="Khánh Duy">Khánh Duy</option>
              </select>
            </div>
            <p class="text-xs text-amber-600 font-medium">***Lưu ý: mỗi nick 1 ngày chỉ nên mời 30 người</p>
          </div>

          <!-- Cache info display -->
          <div id="cacheInfo3" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 flex-1">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span id="cacheText3" class="text-sm text-blue-700 font-medium"></span>
              </div>
              <button id="refreshBtn3" class="flex items-center gap-1 px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 hover:text-purple-800 transition-all duration-200 text-sm font-medium rounded-md border border-purple-300 hover:border-purple-400 flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Quét lại
              </button>
            </div>
          </div>

          <button id="scanBtn3" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-semibold py-3 rounded-xl transition-all duration-300 disabled:opacity-60 touch-manipulation hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl">
            <span>Quét nhóm</span>
            <svg id="spinner3" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection3" class="hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <!-- Cột bên trái: Chọn nhóm nguồn -->
              <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-1">
                  <svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                  </svg>
                  Chọn nhóm nguồn
                </h2>
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 h-80 overflow-y-auto">
                  <div id="sourceGroupList" class="space-y-2">
                    <!-- Danh sách nhóm nguồn sẽ được thêm vào đây -->
                  </div>
                  <p id="emptySourceMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
                </div>
                <div class="text-sm text-gray-600">
                  <span id="selectedSourceCount">0</span> nhóm nguồn được chọn
                </div>
              </div>
              
              <!-- Cột bên phải: Chọn nhóm đích -->
              <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-1">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                  </svg>
                  Chọn nhóm đích
                </h2>
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 h-80 overflow-y-auto">
                  <div id="targetGroupList" class="space-y-2">
                    <!-- Danh sách nhóm đích sẽ được thêm vào đây -->
                  </div>
                  <p id="emptyTargetMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
                </div>
                <div class="text-sm text-gray-600">
                  <span id="selectedTargetCount">0</span> nhóm đích được chọn
                </div>
              </div>
            </div>
            <div id="actionsBox3" class="space-y-3 pt-4 border-t border-gray-200">
              <button id="nextBtn3" class="w-full flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>

        <!-- STEP 2: QUÉT THÀNH VIÊN VÀ MỜI -->
        <div id="step3_2" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Quét và mời thành viên</h2>
            <div class="text-sm text-gray-600 break-words">
              <p id="sourceGroupDisplay" class="font-medium"></p>
              <p id="targetGroupDisplay" class="font-medium"></p>
            </div>
          </header>

          <div class="space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    Số lượng thành viên quét được
                  </span>
                </label>
                <div id="memberCount" class="text-xl font-semibold text-purple-600">0</div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Số lượng nhóm đã mời
                  </span>
                </label>
                <div id="invitedCount" class="text-xl font-semibold text-green-600">0</div>
              </div>
            </div>

            <div class="hidden">
              <input 
                type="hidden" 
                id="maxInvites" 
                value="1"
              />
            </div>

            <div class="flex gap-2 items-center">
              <input type="checkbox" id="autoInvite" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
              <label for="autoInvite" class="text-sm text-gray-600">Tự động mời khi quét xong</label>
            </div>
          </div>

          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="backBtn3" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
              <button id="scanMembersBtn" class="flex-1 flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
                <span>Quét thành viên</span>
                <svg id="scanMembersSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
              </button>
            </div>
            
            <button id="inviteBtn" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation" disabled>
              <span>Mời thành viên</span>
              <svg id="inviteSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>

          <div id="progressContainer" class="hidden space-y-2">
            <div class="flex justify-between text-sm text-gray-600">
              <span>Tiến trình</span>
              <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progressBar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <script>
    // Function to process webhook URLs
    function processWebhookUrl(url) {
      if (!url) return '';
      
      // If it's a full URL, use it directly via our proxy logic
      if (url.startsWith('http')) {
        try {
          // Extract the path (and keep query) for the proxy. Example: /webhook/info-zalo-cuong?key=abc
          const u = new URL(url);
          return `${u.pathname}${u.search || ''}`;
        } catch (e) {
          console.error("Invalid webhook URL provided:", url);
          return ''; // Return empty string for invalid URLs
        }
      }
      
      // Handle old relative paths if they exist
      if (url.startsWith('/api/webhook/')) {
        return url.replace('/api/webhook/', '/webhook/');
      }
      
      // If it's already a correct relative path, return it as is
      return url;
    }

    // Function to get current webhooks from localStorage
    function getCurrentWebhooks() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      const webhooks = {
        scanWebhook: processWebhookUrl(currentUser.scanWebhook || '/webhook/zalo-automation'),
        sendWebhook: processWebhookUrl(currentUser.sendWebhook || '/webhook/zalo-sent-text-image'),
        postWebhook: processWebhookUrl(currentUser.postWebhook || '/webhook/zalo-post-group'),
        inviteWebhook: processWebhookUrl(currentUser.inviteWebhook || '/webhook/zalo-invite-member'),
        scanMembersWebhook: processWebhookUrl(currentUser.scanMembersWebhook || '/webhook/zalo-scan-members')
      };
      
      console.log('Current webhook URLs from localStorage:');
      console.log('- scanWebhook:', webhooks.scanWebhook);
      console.log('- sendWebhook:', webhooks.sendWebhook);
      console.log('- postWebhook:', webhooks.postWebhook);
      console.log('- inviteWebhook:', webhooks.inviteWebhook);
      console.log('- scanMembersWebhook:', webhooks.scanMembersWebhook);
      
      return webhooks;
    }

    // Function to refresh user data and webhooks from database
    async function refreshUserData() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      if (!currentUser.username || currentUser.username === 'admin') {
        console.log('Admin user or no user logged in, skipping refresh');
        return { success: true, webhooks: getCurrentWebhooks() };
      }

      try {
        console.log('🔄 Refreshing user data from database for user:', currentUser.username);
        
        // Initialize Supabase if not done yet
        if (!window.supabaseService || !window.supabaseService.initialized) {
          if (typeof CONFIG !== 'undefined' && CONFIG.supabase) {
            await window.supabaseService.init(CONFIG.supabase);
          }
        }
        
        const { data: userData, error } = await window.supabaseService.getUserByUsername(currentUser.username);
        
        if (error || !userData) {
          console.error('Failed to refresh user data:', error);
          return { success: false, webhooks: getCurrentWebhooks(), error: error };
        }
        
        // Update localStorage with fresh data
        const { password: _, ...userWithoutPassword } = userData;
        localStorage.setItem('currentUser', JSON.stringify(userWithoutPassword));
        
        console.log('✅ User data refreshed successfully');
        console.log('Updated webhooks:', {
          scan: userData.scanWebhook,
          send: userData.sendWebhook,
          post: userData.postWebhook,
          invite: userData.inviteWebhook,
          scanMembers: userData.scanMembersWebhook
        });
        
        return { success: true, webhooks: getCurrentWebhooks() };
      } catch (error) {
        console.error('Error refreshing user data:', error);
        return { success: false, webhooks: getCurrentWebhooks(), error: error.message };
      }
    }

    // Get initial webhooks
    let webhooks = getCurrentWebhooks()

    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = 'admin@123';

    const $ = id => document.getElementById(id);
    const toggle = (el, show) => {
      if (!el) {
        console.warn('Toggle called with null element');
        return;
      }
      el.classList[show ? 'remove' : 'add']('hidden');
    };

    // Elements
    const loginPage = $('loginPage');
    const mainApp = $('mainApp');
    const loginForm = $('loginForm');
    const loginError = $('loginError');
    const loginBtn = $('loginBtn');
    const loginBtnText = $('loginBtnText');
    const loginSpinner = $('loginSpinner');
    const logoutBtn = $('logoutBtn');
    const homeBtn = $('homeBtn');
    const togglePassword = $('togglePassword');
    const passwordInput = $('password');
    const eyeOpen = $('eyeOpen');
    const eyeClosed = $('eyeClosed');

    // Pages
    const homePage = $('homePage');
    const feature1Page = $('feature1Page');
    const feature2Page = $('feature2Page');
    const feature3Page = $('feature3Page');
    
    // Feature 2 elements
    const step2_1 = $('step2_1');
    const step2_2 = $('step2_2');
    const step2_3 = $('step2_3');
    const nickSelect2 = $('nickSelect2');
    const scanBtn2 = $('scanBtn2');
    const spinner2 = $('spinner2');
    const resultSection2 = $('resultSection2');
    const groupList2 = $('groupList2');
    const emptyMsg2 = $('emptyMsg2');
    const actionsBox2 = $('actionsBox2');
    const selectAllGroups = $('selectAllGroups');
    const selectedCount = $('selectedCount');
    const nextBtn2 = $('nextBtn2');
    const backBtn2 = $('backBtn2');
    const selectedGroupsDisplay = $('selectedGroupsDisplay');
    
    // Cache UI elements Feature 2
    const cacheInfo2 = $('cacheInfo2');
    const cacheText2 = $('cacheText2');
    const refreshBtn2 = $('refreshBtn2');
    
    // Feature 3 elements
    const step3_1 = $('step3_1');
    const step3_2 = $('step3_2');
    const nickSelect3 = $('nickSelect3');
    const scanBtn3 = $('scanBtn3');
    const spinner3 = $('spinner3');
    const resultSection3 = $('resultSection3');
    const sourceGroupList = $('sourceGroupList');
    const targetGroupList = $('targetGroupList');
    const emptySourceMsg = $('emptySourceMsg');
    const emptyTargetMsg = $('emptyTargetMsg');
    const selectedSourceCount = $('selectedSourceCount');
    const selectedTargetCount = $('selectedTargetCount');
    const actionsBox3 = $('actionsBox3');
    const nextBtn3 = $('nextBtn3');
    const backBtn3 = $('backBtn3');
    const sourceGroupDisplay = $('sourceGroupDisplay');
    const targetGroupDisplay = $('targetGroupDisplay');
    const memberCount = $('memberCount');
    const invitedCount = $('invitedCount');
    const maxInvites = $('maxInvites');
    const autoInvite = $('autoInvite');
    const scanMembersBtn = $('scanMembersBtn');
    const scanMembersSpinner = $('scanMembersSpinner');
    const inviteBtn = $('inviteBtn');
    const inviteSpinner = $('inviteSpinner');
    const progressContainer = $('progressContainer');
    const progressBar = $('progressBar');
    const progressText = $('progressText');
    
    // Cache UI elements Feature 3
    const cacheInfo3 = $('cacheInfo3');
    const cacheText3 = $('cacheText3');
    const refreshBtn3 = $('refreshBtn3');
    
    // Post content elements
    const postContent = $('postContent');
    const postImages = $('postImages');
    const enableSchedule = $('enableSchedule');
    const scheduleInputs = $('scheduleInputs');
    const scheduleMode = $('scheduleMode');
    const onceModeInputs = $('onceModeInputs');
    const weeklyModeInputs = $('weeklyModeInputs');
    const selectedDaysCount = $('selectedDaysCount');
    const selectedDaysText = $('selectedDaysText');
    const scheduleDate = $('scheduleDate');
    const scheduleTime = $('scheduleTime');
    const publishBtn = $('publishBtn');
    const publishSpinner = $('publishSpinner');
    const charCount = $('charCount');
    
    // Scheduled posts elements
    const newScheduledPost = $('newScheduledPost');
    const newPostDetails = $('newPostDetails');
    const scheduledPostsList = $('scheduledPostsList');
    const scheduledPostsCount = $('scheduledPostsCount');
    const noScheduledPosts = $('noScheduledPosts');
    const scheduleNewPostBtn = $('scheduleNewPostBtn');
    const backToHomeBtn = $('backToHomeBtn');
    
    // Post image status elements
    const postImageStatus = $('postImageStatus');
    const postImageSuccess = $('postImageSuccess');
    const postImageWarning = $('postImageWarning');
    const postImageError = $('postImageError');
    const postImageSuccessText = $('postImageSuccessText');
    const postImageWarningText = $('postImageWarningText');
    const postImageErrorText = $('postImageErrorText');

    // Feature cards
    const feature1Card = $('feature1Card');
    const feature2Card = $('feature2Card');
    const feature3Card = $('feature3Card');

    const overlay = $('overlay');
    const overlayText = $('overlayText');
    const step1 = $('step1');
    const step2 = $('step2');
    const nickSelect = $('nickSelect');
    const scanBtn = $('scanBtn');
    const spinner = $('spinner');
    const resultSec = $('resultSection');
    const groupList = $('groupList');
    const emptyMsg = $('emptyMsg');
    const actionsBox = $('actionsBox');
    const groupSelect = $('groupSelect');
    const nextBtn = $('nextBtn');
    const backBtn = $('backBtn');
    const sendMsgBtn = $('sendMsgBtn');
    const spinnerSend = $('spinnerSend');
    
    // Cache UI elements Feature 1
    const cacheInfo1 = $('cacheInfo1');
    const cacheText1 = $('cacheText1');
    const refreshBtn1 = $('refreshBtn1');
    const messageTxt = $('message');
    const imagesInput = $('images');
    const chosenGroup = $('chosenGroup');
    
    // Elements cho thông báo ảnh
    const imageStatus = $('imageStatus');
    const imageCountSuccess = $('imageCountSuccess');
    const imageCountWarning = $('imageCountWarning');
    const imageCountError = $('imageCountError');
    const imageCountText = $('imageCountText');
    const imageWarningText = $('imageWarningText');
    const imageErrorText = $('imageErrorText');

    let currentGroup = { id: '', name: '' };
    let selectedGroups = [];
    let sourceGroups = [];
    let targetGroups = [];
    let members = [];
    let currentIdNick = '';
    let scheduledPosts = JSON.parse(localStorage.getItem('scheduledPosts') || '[]');
    let savedPosts = JSON.parse(localStorage.getItem('savedPosts') || '[]'); // Lưu tối đa 5 bài
    let selectedOldPost = null;

    // Cache quét nhóm theo nick - lưu trong 1 giờ
    const GROUP_CACHE_KEY = 'groupScanCache';
    const CACHE_EXPIRY_HOURS = 1;
    
    // Session expiry tracking - Zalo web session lasts 14 days
    const SESSION_EXPIRY_KEY = 'zaloSessionExpiry';
    const SESSION_DURATION_DAYS = 14;

    // Hàm quản lý cache nhóm
    function getGroupCache(nick) {
      try {
        const cache = JSON.parse(localStorage.getItem(GROUP_CACHE_KEY) || '{}');
        const nickCache = cache[nick];
        if (!nickCache) return null;
        
        const cacheTime = new Date(nickCache.timestamp);
        const now = new Date();
        const hoursDiff = (now - cacheTime) / (1000 * 60 * 60);
        
        if (hoursDiff > CACHE_EXPIRY_HOURS) {
          // Cache hết hạn, xóa và trả về null
          delete cache[nick];
          localStorage.setItem(GROUP_CACHE_KEY, JSON.stringify(cache));
          return null;
        }
        
        return nickCache.groups;
      } catch (error) {
        console.error('Error reading group cache:', error);
        return null;
      }
    }

    function setGroupCache(nick, groups) {
      try {
        const cache = JSON.parse(localStorage.getItem(GROUP_CACHE_KEY) || '{}');
        cache[nick] = {
          groups: groups,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(GROUP_CACHE_KEY, JSON.stringify(cache));
        
        // Update session expiry tracking when successfully scanning groups
        updateSessionExpiry(nick);
      } catch (error) {
        console.error('Error saving group cache:', error);
      }
    }

    function clearGroupCache(nick = null) {
      try {
        if (nick) {
          // Xóa cache của nick cụ thể
          const cache = JSON.parse(localStorage.getItem(GROUP_CACHE_KEY) || '{}');
          delete cache[nick];
          localStorage.setItem(GROUP_CACHE_KEY, JSON.stringify(cache));
        } else {
          // Xóa toàn bộ cache
          localStorage.removeItem(GROUP_CACHE_KEY);
        }
      } catch (error) {
        console.error('Error clearing group cache:', error);
      }
    }

    function getCacheInfo(nick) {
      try {
        const cache = JSON.parse(localStorage.getItem(GROUP_CACHE_KEY) || '{}');
        const nickCache = cache[nick];
        if (!nickCache) return null;
        
        const cacheTime = new Date(nickCache.timestamp);
        const now = new Date();
        const minutesAgo = Math.floor((now - cacheTime) / (1000 * 60));
        
        return {
          groupCount: nickCache.groups.length,
          minutesAgo: minutesAgo,
          timestamp: cacheTime
        };
      } catch (error) {
        console.error('Error getting cache info:', error);
        return null;
      }
    }
    
    // ==================== SESSION EXPIRY MANAGEMENT ====================
    
    /**
     * Update session expiry for a nick when successfully scanning groups
     */
    function updateSessionExpiry(nick) {
      try {
        const sessionData = JSON.parse(localStorage.getItem(SESSION_EXPIRY_KEY) || '{}');
        const now = new Date();
        const expiryDate = new Date(now.getTime() + (SESSION_DURATION_DAYS * 24 * 60 * 60 * 1000));
        
        sessionData[nick] = {
          lastSuccessfulScan: now.toISOString(),
          sessionExpiry: expiryDate.toISOString()
        };
        
        localStorage.setItem(SESSION_EXPIRY_KEY, JSON.stringify(sessionData));
        console.log(`Updated session expiry for nick: ${nick}, expires: ${expiryDate.toLocaleString('vi-VN')}`);
      } catch (error) {
        console.error('Error updating session expiry:', error);
      }
    }
    
    /**
     * Get session expiry info for a nick
     */
    function getSessionExpiry(nick) {
      try {
        const sessionData = JSON.parse(localStorage.getItem(SESSION_EXPIRY_KEY) || '{}');
        const nickData = sessionData[nick];
        
        if (!nickData) return null;
        
        const now = new Date();
        const expiryDate = new Date(nickData.sessionExpiry);
        const lastScanDate = new Date(nickData.lastSuccessfulScan);
        
        const timeLeft = expiryDate - now;
        const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
        const hoursLeft = Math.ceil(timeLeft / (1000 * 60 * 60));
        
        return {
          lastScan: lastScanDate,
          expiryDate: expiryDate,
          timeLeft: timeLeft,
          daysLeft: daysLeft,
          hoursLeft: hoursLeft,
          isExpired: timeLeft <= 0,
          isExpiringSoon: daysLeft <= 2 // Warning when < 2 days left
        };
      } catch (error) {
        console.error('Error getting session expiry:', error);
        return null;
      }
    }
    
    /**
     * Format countdown text for display
     */
    function formatCountdown(sessionInfo) {
      if (!sessionInfo) return '';
      
      if (sessionInfo.isExpired) {
        return '⚠️ Phiên đăng nhập đã hết hạn - Cần đăng nhập lại';
      }
      
      const { daysLeft, hoursLeft } = sessionInfo;
      
      if (daysLeft > 1) {
        return `🕒 Còn ${daysLeft} ngày để đăng nhập lại`;
      } else if (hoursLeft > 1) {
        return `⏰ Còn ${hoursLeft} giờ để đăng nhập lại`;
      } else {
        return '🚨 Sắp hết hạn - Nên đăng nhập lại ngay';
      }
    }
    
    /**
     * Update countdown display for all visible cache displays
     */
    function updateAllCountdowns() {
      // Update Feature 1
      const nick1 = nickSelect?.value;
      if (nick1 && getCacheInfo(nick1)) {
        updateCacheDisplay(1, nick1);
      }
      
      // Update Feature 2
      const nick2 = nickSelect2?.value;
      if (nick2 && getCacheInfo(nick2)) {
        updateCacheDisplay(2, nick2);
      }
      
      // Update Feature 3
      const nick3 = nickSelect3?.value;
      if (nick3 && getCacheInfo(nick3)) {
        updateCacheDisplay(3, nick3);
      }
    }

    // Functions để cập nhật hiển thị cache UI
    function updateCacheDisplay(featureNum, nick) {
      const cacheInfoElement = featureNum === 1 ? cacheInfo1 : featureNum === 2 ? cacheInfo2 : cacheInfo3;
      const cacheTextElement = featureNum === 1 ? cacheText1 : featureNum === 2 ? cacheText2 : cacheText3;
      
      // Chỉ hiển thị khi đã chọn nick và có cache
      if (!nick || nick === '') {
        toggle(cacheInfoElement, false);
        return;
      }
      
      const cacheInfo = getCacheInfo(nick);
      if (cacheInfo) {
        const timeText = cacheInfo.minutesAgo === 0 ? 'vừa xong' : 
                        cacheInfo.minutesAgo < 60 ? `${cacheInfo.minutesAgo} phút trước` : 
                        `${Math.floor(cacheInfo.minutesAgo / 60)} giờ trước`;
        
        // Get session expiry info for countdown
        const sessionInfo = getSessionExpiry(nick);
        const countdownText = sessionInfo ? formatCountdown(sessionInfo) : '';
        
        // Combine cache info with countdown
        let displayText = `Có ${cacheInfo.groupCount} nhóm đã lưu (${timeText}) - Tự động hiển thị`;
        if (countdownText) {
          displayText += `\n${countdownText}`;
        }
        
        cacheTextElement.innerHTML = displayText.replace('\n', '<br><small class="text-xs opacity-75">') + '</small>';
        toggle(cacheInfoElement, true);
      } else {
        toggle(cacheInfoElement, false);
      }
    }

    function loadGroupsFromCache(featureNum, nick) {
      const cachedGroups = getGroupCache(nick);
      if (!cachedGroups) return false;

      // Load groups vào UI tương ứng
      if (featureNum === 1) {
        // Feature 1: Load vào dropdown và list
        groupList.innerHTML = '';
        groupSelect.innerHTML = '';
        
        if (cachedGroups.length === 0) {
          toggle(emptyMsg, true);
        } else {
          toggle(emptyMsg, false);
          cachedGroups.forEach((g, index) => {
            groupList.insertAdjacentHTML('beforeend', `<li>${g.name}</li>`);
            groupSelect.insertAdjacentHTML('beforeend', `<option value="${g.id}">${g.name}</option>`);
          });
          toggle(actionsBox, true);
        }
        toggle(resultSec, true);
        
      } else if (featureNum === 2) {
        // Feature 2: Load vào checkboxes
        groupList2.innerHTML = '';
        selectedGroups = [];
        
        if (cachedGroups.length === 0) {
          toggle(emptyMsg2, true);
        } else {
          toggle(emptyMsg2, false);
          cachedGroups.forEach((g, index) => {
            groupList2.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateSelectedGroupsCount()"
                >
                <label for="group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
          toggle(actionsBox2, true);
        }
        toggle(resultSection2, true);
        updateSelectedGroupsCount();
        
      } else if (featureNum === 3) {
        // Feature 3: Load vào source và target lists
        sourceGroupList.innerHTML = '';
        targetGroupList.innerHTML = '';
        sourceGroups = [];
        targetGroups = [];
        
        if (cachedGroups.length === 0) {
          toggle(emptySourceMsg, true);
          toggle(emptyTargetMsg, true);
        } else {
          toggle(emptySourceMsg, false);
          toggle(emptyTargetMsg, false);
          
          cachedGroups.forEach((g, index) => {
            // Thêm vào source list
            sourceGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="source_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                  onchange="updateSourceGroupsCount()"
                >
                <label for="source_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
            
            // Thêm vào target list
            targetGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="target_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateTargetGroupsCount()"
                >
                <label for="target_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
        }
        toggle(resultSection3, true);
        toggle(actionsBox3, true);
        updateSourceGroupsCount();
        updateTargetGroupsCount();
      }
      
      return true;
    }

    // Hàm hiển thị trang
    function showPage(pageToShow) {
      toggle(homePage, false);
      toggle(feature1Page, false);
      toggle(feature2Page, false);
      toggle(feature3Page, false);
      toggle(pageToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Hàm hiển thị step cho feature 2
    function showFeature2Step(stepToShow) {
      toggle(step2_1, false);
      toggle($('step2_1_5'), false);
      toggle(step2_2, false);
      toggle($('step2_3'), false);
      toggle(stepToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Hàm hiển thị step cho feature 3
    function showFeature3Step(stepToShow) {
      toggle(step3_1, false);
      toggle(step3_2, false);
      toggle(stepToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Hàm kiểm tra số lượng ảnh cho tin nhắn
    function checkImageCount() {
      const fileCount = imagesInput.files.length;
      toggle(imageCountSuccess, false);
      toggle(imageCountWarning, false);
      toggle(imageCountError, false);
      
      if (fileCount === 0) {
        toggle(imageStatus, false);
        return;
      }
      
      toggle(imageStatus, true);
      
      if (fileCount === 3) {
        toggle(imageCountSuccess, true);
        imageCountText.textContent = "Đã tải đủ 3 ảnh - Hoàn hảo!";
      } else if (fileCount < 3) {
        toggle(imageCountWarning, true);
        imageWarningText.textContent = `Đã tải ${fileCount} ảnh. Hãy tải thêm ${3 - fileCount} ảnh nữa để đủ 3 ảnh.`;
      } else {
        toggle(imageCountError, true);
        imageErrorText.textContent = `Đã tải ${fileCount} ảnh. Vui lòng xóa bớt ${fileCount - 3} ảnh hoặc tải lại để đủ 3 ảnh.`;
      }
    }
    
    // Hàm kiểm tra số lượng ảnh cho đăng bài
    function checkPostImageCount() {
      const fileCount = postImages.files.length;
      toggle(postImageSuccess, false);
      toggle(postImageWarning, false);
      toggle(postImageError, false);
      
      if (fileCount === 0) {
        toggle(postImageStatus, false);
        return;
      }
      
      toggle(postImageStatus, true);
      
      if (fileCount === 4) {
        toggle(postImageSuccess, true);
        postImageSuccessText.textContent = "Đã tải đủ 4 ảnh - Hoàn hảo!";
      } else if (fileCount < 4) {
        toggle(postImageWarning, true);
        postImageWarningText.textContent = `Đã tải ${fileCount} ảnh. Cần tải thêm ${4 - fileCount} ảnh nữa để đủ 4 ảnh.`;
      } else {
        toggle(postImageError, true);
        postImageErrorText.textContent = `Đã tải ${fileCount} ảnh. Vui lòng xóa bớt ${fileCount - 4} ảnh hoặc tải lại để đủ 4 ảnh.`;
      }
    }
    
    // Hàm cập nhật số ký tự
    function updateCharCount() {
      const count = postContent.value.length;
      charCount.textContent = count;
      charCount.className = count > 1000 ? 'text-red-500' : 'text-gray-500';
    }
    
    // Hàm cập nhật số nhóm được chọn cho tính năng 2
    function updateSelectedGroupsCount() {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]:checked');
      selectedCount.textContent = checkboxes.length;
      nextBtn2.disabled = checkboxes.length === 0;
      
      selectedGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
    }
    
    // Hàm cập nhật số nhóm nguồn được chọn cho tính năng 3
    function updateSourceGroupsCount() {
      const checkboxes = document.querySelectorAll('#sourceGroupList input[type="checkbox"]:checked');
      selectedSourceCount.textContent = checkboxes.length;
      
      sourceGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
      
      updateNextButton3State();
    }
    
    // Hàm cập nhật số nhóm đích được chọn cho tính năng 3
    function updateTargetGroupsCount() {
      const checkboxes = document.querySelectorAll('#targetGroupList input[type="checkbox"]:checked');
      selectedTargetCount.textContent = checkboxes.length;
      
      targetGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
      
      updateNextButton3State();
    }
    
    // Cập nhật trạng thái của nút tiếp tục trong tính năng 3
    function updateNextButton3State() {
      nextBtn3.disabled = sourceGroups.length === 0 || targetGroups.length === 0;
    }
    
    // Hàm hiển thị thông báo thành công với tích xanh
    function showSuccessMessage(message) {
      overlayText.innerHTML = `
        <div class="flex flex-col items-center gap-3">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
          </div>
          <p class="text-green-600 font-medium">${message}</p>
        </div>
      `;
    }

    // ==================== SESSION EXPIRY & ERROR HANDLING ====================
    
    /**
     * Enhanced error handler with session expiry detection
     * @param {Error} error - The error object
     * @param {string} context - Context where error occurred (e.g., 'scan_groups', 'send_message')
     * @param {string} nick - Current nick being used
     * @returns {Object} - { isSessionExpired: boolean, userMessage: string }
     */
    function handleWebhookError(error, context, nick) {
      console.error(`[${context}] Error for nick ${nick}:`, error);
      
      let isSessionExpired = false;
      let userMessage = '';
      let errorType = 'unknown';
      
      // Detect session expiry scenarios
      if (error.message.includes('EMPTY_RESPONSE')) {
        errorType = 'empty_response';
        isSessionExpired = true;
        userMessage = `📭 <strong>Webhook trả về response rỗng</strong><br><br>
          Nguyên nhân có thể:<br>
          • <strong>Nick "${nick}" chưa đăng nhập vào Zalo</strong><br>
          • Phiên đăng nhập đã hết hạn<br>
          • Webhook backend chưa được cấu hình đúng<br><br>
          <strong>Giải pháp:</strong><br>
          1. Mở ứng dụng Zalo trên thiết bị<br>
          2. Đảm bảo nick "${nick}" đã đăng nhập<br>
          3. Quay lại đây và thử lại`;
      } else if (error.message.includes('INVALID_JSON')) {
        errorType = 'invalid_json';
        isSessionExpired = true; // Likely session expired
        const responseSnippet = error.message.split('Response: ')[1] || 'N/A';
        userMessage = `📄 <strong>Webhook trả về dữ liệu không hợp lệ</strong><br><br>
          Response từ webhook không phải là JSON hợp lệ.<br><br>
          Response nhận được: <code class="text-xs bg-gray-100 p-1 rounded">${responseSnippet}</code><br><br>
          Nguyên nhân có thể:<br>
          • <strong>Nick "${nick}" cần đăng nhập lại vào Zalo</strong><br>
          • Webhook backend trả về format không đúng<br>
          • Zalo API đang có vấn đề<br><br>
          <strong>Khuyến nghị:</strong> Đăng nhập lại vào Zalo với nick "${nick}"`;
      } else if (error.name === 'AbortError') {
        errorType = 'timeout';
        isSessionExpired = true;
        userMessage = `⏱️ <strong>Hết thời gian chờ phản hồi từ Zalo</strong><br><br>
          Có thể do:<br>
          • <strong>Phiên đăng nhập của nick "${nick}" đã hết hạn</strong><br>
          • Kết nối mạng chậm hoặc webhook backend bị quá tải<br>
          • Zalo đang bảo trì<br><br>
          <strong>Khuyến nghị:</strong> Đăng nhập lại vào Zalo với nick "${nick}" và thử lại.`;
      } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
        errorType = 'network';
        userMessage = `🌐 <strong>Lỗi kết nối mạng</strong><br><br>
          Không thể kết nối đến webhook server.<br><br>
          Vui lòng kiểm tra:<br>
          • Kết nối internet<br>
          • Webhook server có đang hoạt động không<br>
          • Firewall hoặc VPN có chặn không`;
      } else if (error.message.includes('status 401') || error.message.includes('Unauthorized')) {
        errorType = 'unauthorized';
        isSessionExpired = true;
        userMessage = `🔒 <strong>Phiên đăng nhập đã hết hạn</strong><br><br>
          Nick "${nick}" cần đăng nhập lại vào Zalo.<br><br>
          Vui lòng:<br>
          1. Mở ứng dụng Zalo<br>
          2. Đăng nhập lại với nick "${nick}"<br>
          3. Quay lại đây và thử lại`;
      } else if (error.message.includes('status 500') || error.message.includes('status 502') || error.message.includes('status 503')) {
        errorType = 'server_error';
        userMessage = `⚠️ <strong>Lỗi server backend</strong><br><br>
          Webhook server đang gặp sự cố.<br><br>
          Vui lòng:<br>
          • Thử lại sau vài phút<br>
          • Liên hệ admin nếu lỗi vẫn tiếp diễn`;
      } else if (error.message.includes('JSON') || error.message.includes('parse')) {
        errorType = 'invalid_response';
        isSessionExpired = true;
        userMessage = `📄 <strong>Dữ liệu phản hồi không hợp lệ</strong><br><br>
          Webhook trả về dữ liệu không đúng định dạng.<br><br>
          Có thể nick "${nick}" cần đăng nhập lại hoặc webhook cần được cấu hình lại.`;
      } else {
        errorType = 'unknown';
        userMessage = `❌ <strong>Lỗi không xác định</strong><br><br>
          ${error.message || 'Đã xảy ra lỗi khi xử lý yêu cầu.'}<br><br>
          Nếu lỗi này lặp lại, có thể phiên đăng nhập Zalo đã hết hạn.<br>
          Vui lòng đăng nhập lại vào Zalo với nick "${nick}".`;
      }
      
      // Log for analytics
      logErrorEvent({
        context,
        nick,
        errorType,
        isSessionExpired,
        timestamp: new Date().toISOString(),
        errorMessage: error.message
      });
      
      return { isSessionExpired, userMessage, errorType };
    }
    
    /**
     * Log error events to localStorage for troubleshooting
     */
    function logErrorEvent(errorData) {
      try {
        const errorLogs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
        errorLogs.unshift(errorData);
        
        // Keep only last 50 errors
        if (errorLogs.length > 50) {
          errorLogs.splice(50);
        }
        
        localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
        console.log('Error logged:', errorData);
      } catch (e) {
        console.warn('Failed to log error:', e);
      }
    }
    
    /**
     * Show error overlay with session expiry warning
     */
    function showErrorOverlay(userMessage, isSessionExpired = false) {
      const iconColor = isSessionExpired ? 'text-orange-500' : 'text-red-500';
      const bgColor = isSessionExpired ? 'bg-orange-500' : 'bg-red-500';
      
      overlayText.innerHTML = `
        <div class="flex flex-col items-center gap-4 max-w-2xl">
          <div class="w-16 h-16 ${bgColor} rounded-full flex items-center justify-center animate-pulse">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="text-center ${iconColor}">
            ${userMessage}
          </div>
          ${isSessionExpired ? `
            <div class="mt-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
              <p class="text-sm text-yellow-800 font-semibold">💡 Hướng dẫn đăng nhập lại:</p>
              <ol class="text-sm text-yellow-700 mt-2 space-y-1 text-left">
                <li>1. Mở ứng dụng Zalo trên thiết bị</li>
                <li>2. Chọn nick cần đăng nhập lại</li>
                <li>3. Đăng nhập với tài khoản và mật khẩu</li>
                <li>4. Quay lại đây và thử lại</li>
              </ol>
            </div>
          ` : ''}
          <button onclick="toggle(overlay, false)" class="mt-4 px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors">
            Đóng
          </button>
        </div>
      `;
      
      toggle(overlay, true);
    }
    
    /**
     * Enhanced fetch with better error handling and timeout
     */
    async function fetchWithTimeout(url, options = {}, timeoutMs = 150000) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        throw error;
      }
    }

    // Hàm lưu bài đăng đã lên lịch
    function saveScheduledPost(postData) {
      scheduledPosts.unshift(postData);
      localStorage.setItem('scheduledPosts', JSON.stringify(scheduledPosts));
      updateScheduledPostsList();
    }

    // Hàm lưu bài viết để tái sử dụng (tối đa 5 bài)
    function savePostForReuse(postData) {
      const existingIndex = savedPosts.findIndex(post => post.content === postData.content);
      if (existingIndex !== -1) {
        savedPosts.splice(existingIndex, 1);
      }
      savedPosts.unshift({
        id: Date.now(),
        content: postData.content,
        images: postData.imageUrls || [], // FIX: Use imageUrls
        imageCount: postData.imageCount || 0,
        createdAt: new Date().toISOString(),
        nick: postData.nick
      });
      if (savedPosts.length > 5) {
        savedPosts = savedPosts.slice(0, 5);
      }
      localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
      updateOldPostCount();
    }

    // Hàm cập nhật số lượng bài cũ
    function updateOldPostCount() {
      const oldPostCount = $('oldPostCount');
      if (oldPostCount) {
        oldPostCount.textContent = savedPosts.length;
      }
    }

    // Hàm hiển thị danh sách bài cũ
    function showOldPostsList() {
      const oldPostsList = $('oldPostsList');
      const noOldPosts = $('noOldPosts');
      
      if (!oldPostsList) {
        console.error('oldPostsList element not found!');
        return;
      }
      
      if (savedPosts.length === 0) {
        if (noOldPosts) {
          toggle(noOldPosts, true);
          oldPostsList.innerHTML = noOldPosts.outerHTML;
        } else {
          oldPostsList.innerHTML = '<div class="col-span-full text-center py-16 text-gray-500">Chưa có bài viết nào</div>';
        }
        return;
      }
      
      if (noOldPosts) {
        toggle(noOldPosts, false);
      }
      oldPostsList.innerHTML = '';
      
      savedPosts.forEach((post, index) => {
        const postElement = document.createElement('div');
        postElement.className = 'bg-gradient-to-br from-white via-blue-50 to-purple-50 border-2 border-blue-200 rounded-2xl p-6 hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-purple-300 group';
        postElement.dataset.postIndex = index;
        
        const createdDate = new Date(post.createdAt).toLocaleString('vi-VN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // Tạo preview ảnh mini
        let imagePreview = '';
        if (post.images && post.images.length > 0) {
          const firstImage = post.images[0];
          imagePreview = `
            <div class="w-14 h-14 rounded-lg overflow-hidden border-2 border-white shadow-md">
              <img src="${firstImage}" alt="Preview" class="w-full h-full object-cover">
            </div>
          `;
        }
        
        postElement.innerHTML = `
          <div class="flex gap-4 mb-4">
            ${imagePreview}
            <div class="flex-1 min-w-0">
              <h4 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2 group-hover:text-purple-700 transition-colors">${truncateText(post.content, 100)}</h4>
              <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <span class="flex items-center gap-1 bg-blue-100 px-2 py-1 rounded-full">
                  <svg class="w-3 h-3 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                  </svg>
                  <span class="text-blue-700 font-medium">${post.imageCount} ảnh</span>
                </span>
                <span class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-full">
                  <svg class="w-3 h-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  <span class="text-gray-700 font-medium">${createdDate}</span>
                </span>
              </div>
            </div>
            <div class="flex flex-col justify-center">
              <span class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-green-400 to-blue-500 text-white shadow-sm whitespace-nowrap">
                ✓ Đã lưu
              </span>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button data-action="preview" data-index="${index}" class="flex-1 text-sm bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold px-4 py-3 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                </svg>
                Xem trước
              </span>
            </button>
            <button data-action="select" data-index="${index}" class="flex-1 text-sm bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold px-4 py-3 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Chọn bài này
              </span>
            </button>
          </div>
        `;
        
        oldPostsList.appendChild(postElement);
      });
    }
    // Hàm xem trước bài cũ
    function previewOldPost(index) {
      const post = savedPosts[index];
      selectedOldPost = post;
      
      // Hiển thị nội dung trong modal preview
      $('previewContent').textContent = post.content;
      
      // Hiển thị ảnh theo layout Zalo
      const previewImages = $('previewImages');
      previewImages.innerHTML = '';
      
      if (post.images && post.images.length > 0) {
        const imageCount = post.images.length;
        
        // Layout ảnh giống Zalo
        if (imageCount === 1) {
          previewImages.className = 'grid grid-cols-1 gap-1 rounded-lg overflow-hidden';
          previewImages.innerHTML = `
            <img src="${post.images[0]}" alt="Ảnh 1" class="w-full h-64 object-cover">
          `;
        } else if (imageCount === 2) {
          previewImages.className = 'grid grid-cols-2 gap-1 rounded-lg overflow-hidden';
          post.images.forEach((imageBase64, idx) => {
            previewImages.innerHTML += `
              <img src="${imageBase64}" alt="Ảnh ${idx + 1}" class="w-full h-32 object-cover">
            `;
          });
        } else if (imageCount === 3) {
          previewImages.className = 'grid gap-1 rounded-lg overflow-hidden';
          previewImages.innerHTML = `
            <div class="grid grid-cols-2 gap-1">
              <img src="${post.images[0]}" alt="Ảnh 1" class="w-full h-32 object-cover">
              <div class="grid gap-1">
                <img src="${post.images[1]}" alt="Ảnh 2" class="w-full h-15 object-cover">
                <img src="${post.images[2]}" alt="Ảnh 3" class="w-full h-15 object-cover">
              </div>
            </div>
          `;
        } else if (imageCount === 4) {
          previewImages.className = 'grid grid-cols-2 gap-1 rounded-lg overflow-hidden';
          post.images.forEach((imageBase64, idx) => {
            previewImages.innerHTML += `
              <img src="${imageBase64}" alt="Ảnh ${idx + 1}" class="w-full h-32 object-cover">
            `;
          });
        } else {
          // Hiển thị 4 ảnh đầu với indicator "+X" cho ảnh cuối nếu có nhiều hơn 4
          previewImages.className = 'grid grid-cols-2 gap-1 rounded-lg overflow-hidden';
          for (let i = 0; i < Math.min(4, imageCount); i++) {
            if (i === 3 && imageCount > 4) {
              previewImages.innerHTML += `
                <div class="relative">
                  <img src="${post.images[i]}" alt="Ảnh ${i + 1}" class="w-full h-32 object-cover">
                  <div class="absolute inset-0 bg-black/60 flex items-center justify-center">
                    <span class="text-white font-bold text-lg">+${imageCount - 4}</span>
                  </div>
                </div>
              `;
            } else {
              previewImages.innerHTML += `
                <img src="${post.images[i]}" alt="Ảnh ${i + 1}" class="w-full h-32 object-cover">
              `;
            }
          }
        }
      }
      
      // Hiển thị modal preview
      toggle($('previewModal'), true);
    }

    // Hàm chọn bài cũ
    function selectOldPost(index) {
      selectedOldPost = savedPosts[index];
      toggle($('oldPostModal'), false);
      
      // Chuyển đến bước lên lịch với dữ liệu bài cũ
      showFeature2Step(step2_2);
      
      // Điền dữ liệu vào form
      postContent.value = selectedOldPost.content;
      
      // Xử lý hiển thị ảnh từ bài cũ
      if (selectedOldPost.images && selectedOldPost.images.length > 0) {
        // Tạo thông báo và hiển thị ảnh từ bài cũ
        const imageStatus = $('postImageStatus');
        const postImageSuccess = $('postImageSuccess');
        const postImageSuccessText = $('postImageSuccessText');
        
        toggle(postImageSuccess, true);
        toggle(imageStatus, true);
        postImageSuccessText.innerHTML = `✓ Sử dụng ${selectedOldPost.imageCount} ảnh từ bài viết đã lưu`;
        
        // Ẩn các thông báo khác
        toggle($('postImageWarning'), false);
        toggle($('postImageError'), false);
        
        // Ẩn input file và hiển thị preview ảnh từ bài cũ
        const postImagesInput = $('postImages');
        const postImagesLabel = postImagesInput.previousElementSibling;
        
        // Ẩn input file vì đã có ảnh từ bài cũ
        postImagesInput.style.display = 'none';
        postImagesLabel.style.display = 'none';
        
        // Tạo container hiển thị ảnh từ bài cũ
        let oldImagesPreview = $('oldImagesPreview');
        if (!oldImagesPreview) {
          oldImagesPreview = document.createElement('div');
          oldImagesPreview.id = 'oldImagesPreview';
          postImagesInput.parentNode.insertBefore(oldImagesPreview, imageStatus);
        }
        
        oldImagesPreview.innerHTML = `
          <div class="border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-green-800">Ảnh từ bài viết đã lưu</h4>
                <p class="text-sm text-green-600">${selectedOldPost.imageCount} ảnh sẽ được sử dụng</p>
              </div>
                             <button data-action="switchToNewImages" class="ml-auto text-sm bg-white border border-green-300 text-green-700 px-3 py-1 rounded-lg hover:bg-green-50 transition-colors">
                 Đổi ảnh khác
               </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
              ${selectedOldPost.images.map((imageBase64, idx) => `
                <div class="relative group">
                  <img src="${imageBase64}" alt="Ảnh ${idx + 1}" class="w-full h-20 object-cover rounded-lg border border-green-200">
                  <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all rounded-lg flex items-center justify-center">
                    <span class="text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">Ảnh ${idx + 1}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        // Nếu không có ảnh, hiển thị input file bình thường
        const postImagesInput = $('postImages');
        const postImagesLabel = postImagesInput.previousElementSibling;
        postImagesInput.style.display = 'block';
        postImagesLabel.style.display = 'block';
        
        // Xóa preview ảnh cũ nếu có
        const oldImagesPreview = $('oldImagesPreview');
        if (oldImagesPreview) {
          oldImagesPreview.remove();
        }
      }
      
      updateCharCount();
      
      // Cập nhật hiển thị nhóm đã chọn
      const groupNames = selectedGroups.map(g => g.name).join(', ');
      selectedGroupsDisplay.textContent = `Sẽ đăng bài vào ${selectedGroups.length} nhóm: ${groupNames}`;
    }

    // Hàm chuyển đổi sang tải ảnh mới
    function switchToNewImages() {
      selectedOldPost = null;
      
      // Hiển thị lại input file
      const postImagesInput = $('postImages');
      const postImagesLabel = postImagesInput.previousElementSibling;
      postImagesInput.style.display = 'block';
      postImagesLabel.style.display = 'block';
      
      // Xóa preview ảnh cũ
      const oldImagesPreview = $('oldImagesPreview');
      if (oldImagesPreview) {
        oldImagesPreview.remove();
      }
      
      // Reset trạng thái ảnh
      const imageStatus = $('postImageStatus');
      toggle(imageStatus, false);
      
      // Clear input file
      postImagesInput.value = '';
      checkPostImageCount();
    }

    // Hàm kiểm tra và đảm bảo tất cả elements quan trọng tồn tại
    function ensureCriticalElementsExist() {
      const criticalElements = [
        'useOldPostCard',
        'oldPostModal', 
        'previewModal',
        'oldPostsList'
      ];
      
      let allExist = true;
      criticalElements.forEach(id => {
        if (!$(id)) {
          console.error(`Critical element missing: ${id}`);
          allExist = false;
        }
      });
      
      return allExist;
    }

    // Hàm reset state của tính năng "sử dụng bài cũ"
    function resetOldPostFeatureState() {
      console.log('Resetting old post feature state...');
      
      // Reset biến selectedOldPost
      selectedOldPost = null;
      
      // Reset trạng thái card "sử dụng bài cũ"
      const useOldPostCard = $('useOldPostCard');
      if (useOldPostCard) {
        useOldPostCard.classList.remove('disabled');
        useOldPostCard.style.pointerEvents = '';
        useOldPostCard.style.opacity = '';
      }
      
      // Reset form
      if (postContent) postContent.value = '';
      if (postImages) postImages.value = '';
      
      // Reset trạng thái hiển thị ảnh
      const postImagesInput = $('postImages');
      const postImagesLabel = postImagesInput ? postImagesInput.previousElementSibling : null;
      if (postImagesInput) {
        postImagesInput.style.display = 'block';
        postImagesInput.value = '';
      }
      if (postImagesLabel) {
        postImagesLabel.style.display = 'block';
      }
      
      // Xóa preview ảnh cũ nếu có
      const oldImagesPreview = $('oldImagesPreview');
      if (oldImagesPreview) {
        oldImagesPreview.remove();
      }
      
      // Reset trạng thái ảnh
      const imageStatus = $('postImageStatus');
      if (imageStatus) {
        toggle(imageStatus, false);
      }
      
      // Đóng tất cả modals liên quan
      toggle($('oldPostModal'), false);
      toggle($('previewModal'), false);
      
      console.log('Old post feature state reset completed');
    }

    // Hàm tính toán ngày tiếp theo của một thứ trong tuần
    function getNextDateForDayOfWeek(targetDayOfWeek, scheduleTime) {
      const today = new Date();
      const currentDayOfWeek = today.getDay(); // 0 = Chủ nhật, 1 = Thứ 2, ..., 6 = Thứ 7
      
      // Tính số ngày cần cộng thêm để đến thứ mục tiêu
      let daysToAdd;
      
      if (targetDayOfWeek === currentDayOfWeek) {
        // Nếu hôm nay là thứ mục tiêu, kiểm tra xem giờ đã qua chưa
        const now = new Date();
        const [hours, minutes] = scheduleTime.split(':').map(Number);
        const scheduleDateTime = new Date(today);
        scheduleDateTime.setHours(hours, minutes, 0, 0);
        
        if (scheduleDateTime > now) {
          // Nếu giờ chưa qua, đăng trong hôm nay
          daysToAdd = 0;
        } else {
          // Nếu giờ đã qua, đăng tuần sau
          daysToAdd = 7;
        }
      } else if (targetDayOfWeek > currentDayOfWeek) {
        // Nếu thứ mục tiêu sau thứ hiện tại trong tuần này
        daysToAdd = targetDayOfWeek - currentDayOfWeek;
      } else {
        // Nếu thứ mục tiêu đã qua trong tuần này, lấy thứ đó của tuần sau
        daysToAdd = 7 - (currentDayOfWeek - targetDayOfWeek);
      }
      
      const nextDate = new Date(today);
      nextDate.setDate(today.getDate() + daysToAdd);
      
      // Format thành YYYY-MM-DD
      const year = nextDate.getFullYear();
      const month = String(nextDate.getMonth() + 1).padStart(2, '0');
      const day = String(nextDate.getDate()).padStart(2, '0');
      
      const formattedDate = `${year}-${month}-${day}`;
      
      // Debug log để kiểm tra logic
      console.log(`Tính toán ngày cho thứ ${targetDayOfWeek} lúc ${scheduleTime}:`);
      console.log(`- Hôm nay: ${today.toDateString()} (thứ ${currentDayOfWeek})`);
      console.log(`- Cộng thêm ${daysToAdd} ngày`);
      console.log(`- Kết quả: ${formattedDate}`);
      
      return formattedDate;
    }

    // Hàm kiểm tra xem bài đăng có phải là tương lai không
    function isFuturePost(post) {
      if (!post.schedules || post.schedules.length === 0) {
        return false; // Bài đăng ngay lập tức
      }
      
      const now = new Date();
      
      for (const schedule of post.schedules) {
        if (schedule.type === 'once') {
          const scheduleDate = createLocalDateTime(schedule.date, schedule.time);
          if (scheduleDate > now) {
            return true;
          }
        } else if (schedule.type === 'weekly') {
          // Với bài đăng theo tuần, kiểm tra lần tiếp theo
          const nextDate = getNextDateForDayOfWeek(schedule.dayOfWeek, schedule.time);
          const nextScheduleDateTime = createLocalDateTime(nextDate, schedule.time);
          if (nextScheduleDateTime > now) {
            return true;
          }
        }
      }
      
      return false;
    }
    // Hàm cập nhật danh sách bài đăng đã lên lịch
    function updateScheduledPostsList() {
      // Lọc chỉ những bài đăng tương lai
      const futurePosts = scheduledPosts.filter(isFuturePost);
      
      scheduledPostsCount.textContent = futurePosts.length;
      
      if (futurePosts.length === 0) {
        toggle(noScheduledPosts, true);
        scheduledPostsList.innerHTML = noScheduledPosts.outerHTML;
        return;
      }
      
      toggle(noScheduledPosts, false);
      scheduledPostsList.innerHTML = '';
      
      futurePosts.forEach((post, index) => {
        // Tìm index gốc trong scheduledPosts
        const originalIndex = scheduledPosts.findIndex(p => p === post);
        const postElement = document.createElement('div');
        postElement.className = 'bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow';
        
        let scheduleText = '';
        let statusClass = '';
        let statusText = '';
        
        if (post.schedules && post.schedules.length > 0) {
          if (post.schedules.length === 1) {
            const schedule = post.schedules[0];
            if (schedule.type === 'once') {
              scheduleText = `Lên lịch: ${formatDateTime(schedule.date, schedule.time)}`;
            } else {
              scheduleText = `Lặp lại: ${schedule.dayName} lúc ${schedule.time}`;
            }
          } else {
            scheduleText = `Lặp lại: ${post.schedules.length} ngày trong tuần`;
          }
          statusClass = 'text-orange-600 bg-orange-100';
          statusText = 'Đã lên lịch';
        } else {
          scheduleText = 'Đã đăng ngay lập tức';
          statusClass = 'text-green-600 bg-green-100';
          statusText = 'Đã đăng';
        }
        
        postElement.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1 mr-3">
              <h4 class="font-semibold text-gray-800 text-base mb-1">${truncateText(post.content, 60)}</h4>
              <div class="flex items-center gap-4 text-sm text-gray-500">
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                  </svg>
                  ${post.groups.length} nhóm
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                  </svg>
                  ${post.imageCount} ảnh
                </span>
              </div>
            </div>
            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass} whitespace-nowrap">${statusText}</span>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-3 mb-3">
            <div class="flex items-center gap-2 text-sm text-gray-700">
              <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              <span class="font-medium">${scheduleText}</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Tạo lúc: ${formatDateTime(post.createdAt.split('T')[0], post.createdAt.split('T')[1].split('.')[0])}
            </div>
          </div>
          
          <div class="flex gap-2">
            <button onclick="viewPostDetails(${originalIndex})" class="flex-1 text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium px-4 py-2 rounded-lg transition border border-blue-200">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                </svg>
                Xem chi tiết
              </span>
            </button>
            <button onclick="deleteScheduledPost(${originalIndex})" class="flex-1 text-sm bg-red-50 hover:bg-red-100 text-red-700 font-medium px-4 py-2 rounded-lg transition border border-red-200">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                Xóa
              </span>
            </button>
          </div>
        `;
        
        scheduledPostsList.appendChild(postElement);
      });
    }

    // Hàm hiển thị chi tiết bài đăng mới lên lịch
    function showNewPostDetails(postData) {
      let scheduleText = '';
      
      if (postData.schedules && postData.schedules.length > 0) {
        if (postData.schedules.length === 1) {
          const schedule = postData.schedules[0];
          if (schedule.type === 'once') {
            scheduleText = `${formatDateTime(schedule.date, schedule.time)}`;
          } else {
            scheduleText = `${schedule.dayName} hàng tuần lúc ${schedule.time}`;
          }
        } else {
          scheduleText = `${postData.schedules.length} lịch trình khác nhau (theo tuần)`;
        }
      } else {
        scheduleText = 'Đã đăng ngay lập tức';
      }
      
      newPostDetails.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mt-0.5">
              <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">Nội dung</p>
              <p class="text-gray-600 text-sm mt-1">${truncateText(postData.content, 80)}</p>
            </div>
          </div>
          
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mt-0.5">
              <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">Nhóm đăng bài</p>
              <p class="text-gray-600 text-sm mt-1">${postData.groups.length} nhóm được chọn</p>
            </div>
          </div>
          
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mt-0.5">
              <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">Hình ảnh</p>
              <p class="text-gray-600 text-sm mt-1">${postData.imageCount} ảnh đính kèm</p>
            </div>
          </div>
          
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mt-0.5">
              <svg class="w-4 h-4 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">Lịch trình</p>
              <p class="text-gray-600 text-sm mt-1">${scheduleText}</p>
            </div>
          </div>
        </div>
        
        ${postData.successCount && postData.totalSchedules ? `
        <div class="mt-4 pt-4 border-t border-green-200">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-green-800">Trạng thái thực hiện</span>
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <span class="text-sm font-semibold text-green-700">${postData.successCount}/${postData.totalSchedules} thành công</span>
            </div>
          </div>
        </div>
        ` : ''}
      `;
    }

    // Hàm cắt ngắn văn bản
    function truncateText(text, maxLength) {
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Helper function để tạo Date object chính xác từ date và time string
    function createLocalDateTime(date, time) {
      const [year, month, day] = date.split('-').map(Number);
      const [hours, minutes] = time.split(':').map(Number);
      // Tạo Date object với thời gian địa phương
      return new Date(year, month - 1, day, hours, minutes);
    }

    // Hàm định dạng ngày giờ
    function formatDateTime(date, time) {
      const dateObj = createLocalDateTime(date, time);
      
      return dateObj.toLocaleString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'Asia/Ho_Chi_Minh'
      });
    }

    // Hàm xem chi tiết bài đăng
    function viewPostDetails(index) {
      const post = scheduledPosts[index];
      const groupNames = post.groups.map(g => g.name).join(', ');
      
      let scheduleDetails = '';
      if (post.schedules && post.schedules.length > 0) {
        if (post.schedules.length === 1) {
          const schedule = post.schedules[0];
          if (schedule.type === 'once') {
            scheduleDetails = `Lên lịch: ${formatDateTime(schedule.date, schedule.time)}`;
          } else {
            scheduleDetails = `Lặp lại: ${schedule.dayName} lúc ${schedule.time}`;
          }
        } else {
          scheduleDetails = 'Lặp lại theo tuần:\n';
          post.schedules.forEach(schedule => {
            scheduleDetails += `• ${schedule.dayName} lúc ${schedule.time}\n`;
          });
        }
      } else {
        scheduleDetails = 'Đã đăng ngay lập tức';
      }
      
      const statusInfo = post.successCount && post.totalSchedules 
        ? `\n\nTrạng thái: ${post.successCount}/${post.totalSchedules} thành công`
        : '';
      
      alert(`Chi tiết bài đăng:

Nội dung: ${post.content}

Nhóm đăng bài: ${groupNames}

Số ảnh: ${post.imageCount}

Lịch trình: ${scheduleDetails}${statusInfo}

Tạo lúc: ${formatDateTime(post.createdAt.split('T')[0], post.createdAt.split('T')[1].split('.')[0])}`);
    }

    // Hàm xóa bài đăng đã lên lịch
    function deleteScheduledPost(index) {
      if (confirm('Bạn có chắc chắn muốn xóa bài đăng này khỏi danh sách lên lịch?')) {
        scheduledPosts.splice(index, 1);
        localStorage.setItem('scheduledPosts', JSON.stringify(scheduledPosts));
        updateScheduledPostsList();
      }
    }

    // Kiểm tra đăng nhập khi load trang
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('zalo_scanner_logged_in');
      if (isLoggedIn === 'true') {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        // Check if redirect to admin panel
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('redirect') === 'admin' && currentUser.isAdmin) {
          window.location.href = '/admin';
          return;
        }
        
        showMainApp();
        // Show admin button if admin
        if (currentUser.isAdmin) {
          toggle($('adminBtn'), true);
        } else if (currentUser.nicks) {
          // Update nick selects for regular user
          updateNickSelects(currentUser.nicks);
        }
      } else {
        showLoginPage();
        
        // Show message if redirected from admin
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('redirect') === 'admin') {
          setTimeout(() => {
            const loginError = $('loginError');
            loginError.querySelector('p').textContent = 'Vui lòng đăng nhập với tài khoản admin để truy cập Admin Panel!';
            toggle(loginError, true);
          }, 100);
        }
      }
    }

    function showLoginPage() {
      toggle(loginPage, true);
      toggle(mainApp, false);
    }

    function showMainApp() {
      toggle(loginPage, false);
      toggle(mainApp, true);
      showPage(homePage);
      updateDashboard();
    }
    // Update dashboard with user information
    function updateDashboard() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      // Update user display name
      const userDisplayName = document.getElementById('userDisplayName');
      const userFullName = document.getElementById('userFullName');
      const userInitials = document.getElementById('userInitials');
      const userNickCount = document.getElementById('userNickCount');
      const userNickCountStat = document.getElementById('userNickCountStat');
      
      if (currentUser.username) {
        const displayName = currentUser.fullName || currentUser.username;
        userDisplayName.textContent = displayName;
        userFullName.textContent = displayName;
        
        // Generate initials
        const initials = displayName.split(' ')
          .map(word => word.charAt(0))
          .join('')
          .toUpperCase()
          .substring(0, 2);
        userInitials.textContent = initials;
        
        // Update nick count
        const nickCount = currentUser.nicks ? currentUser.nicks.length : 0;
        userNickCount.textContent = nickCount;
        userNickCountStat.textContent = nickCount;
      }
      
      // Update current date and time
      updateDateTime();
      
      // Start clock update (only if not already started)
      if (!window.clockInterval) {
        window.clockInterval = setInterval(updateDateTime, 1000);
      }
    }
    
    // Update date and time
    function updateDateTime() {
      const now = new Date();
      
      // Format date
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
      };
      const dateStr = now.toLocaleDateString('vi-VN', options);
      document.getElementById('currentDate').textContent = dateStr;
      
      // Format time
      const timeStr = now.toLocaleTimeString('vi-VN', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      document.getElementById('currentTime').textContent = timeStr;
    }
    
    // Show login message
    function showLoginMessage(message, className = 'text-blue-600') {
      const loginError = $('loginError');
      const errorMsg = loginError.querySelector('p');
      errorMsg.textContent = message;
      errorMsg.className = `text-sm ${className}`;
      toggle(loginError, true);
    }
    
    // Update nick selects with user's nicks
    function updateNickSelects(nicks) {
      // Clear existing options except the default one
      const selects = [nickSelect, nickSelect2, nickSelect3];
      
      selects.forEach(select => {
        // Keep the first option (placeholder)
        const firstOption = select.options[0];
        select.innerHTML = '';
        if (firstOption) {
          select.appendChild(firstOption);
        }
        
        // Add user's nicks
        nicks.forEach(nick => {
          const option = document.createElement('option');
          option.value = nick;
          option.textContent = nick;
          select.appendChild(option);
        });
      });
    }
// Event listeners cho các tính năng
    feature1Card.addEventListener('click', () => {
      showPage(feature1Page);
    });

    feature2Card.addEventListener('click', () => {
      showPage(feature2Page);
      showFeature2Step(step2_1);
    });

    feature3Card.addEventListener('click', () => {
      showPage(feature3Page);
      showFeature3Step(step3_1);
    });

    // Nút Home
    homeBtn.addEventListener('click', () => {
      showPage(homePage);
      toggle(step1, true);
      toggle(step2, false);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      nickSelect.selectedIndex = 0;
      messageTxt.value = '';
      imagesInput.value = '';
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';
      checkImageCount();
      
      showFeature2Step(step2_1);
      // Reset feature 2 form
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      nickSelect2.selectedIndex = 0;
      postContent.value = '';
      postImages.value = '';
      groupList2.innerHTML = '';
      selectedGroups = [];
      selectedOldPost = null;
      enableSchedule.checked = false;
      toggle(scheduleInputs, false);
      scheduleMode.value = 'once';
      toggle(onceModeInputs, true);
      toggle(weeklyModeInputs, false);
      toggle(selectedDaysCount, false);
      document.querySelectorAll('.day-checkbox').forEach(cb => {
        cb.checked = false;
        const timeInput = $('time_' + cb.value);
        if (timeInput) {
          timeInput.disabled = true;
          timeInput.value = '';
        }
      });
      updateCharCount();
      checkPostImageCount();
      
      showFeature3Step(step3_1);
      toggle(resultSection3, false);
      toggle(actionsBox3, false);
      sourceGroupList.innerHTML = '';
      targetGroupList.innerHTML = '';
      sourceGroups = [];
      targetGroups = [];
      members = [];
      memberCount.textContent = '0';
      invitedCount.textContent = '0';
      toggle(progressContainer, false);
    });

    // Event listener cho input file
    imagesInput.addEventListener('change', checkImageCount);
    postImages.addEventListener('change', checkPostImageCount);
    
    // Event listener cho textarea
    postContent.addEventListener('input', updateCharCount);
    
    // Hàm cập nhật số ngày được chọn cho chế độ tuần
    function updateSelectedDaysCount() {
      const checkedDays = document.querySelectorAll('.day-checkbox:checked');
      const count = checkedDays.length;
      selectedDaysText.textContent = `${count} ngày`;
      
      if (scheduleMode.value === 'weekly') {
        toggle(selectedDaysCount, count > 0);
      }
    }

    // Event listener cho hẹn giờ
    enableSchedule.addEventListener('change', () => {
      if (enableSchedule.checked) {
        toggle(scheduleInputs, true);
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        scheduleDate.value = tomorrow.toISOString().split('T')[0];
        scheduleTime.value = '09:00';
        
        // Mặc định chọn chế độ đăng một lần
        scheduleMode.value = 'once';
        toggle(onceModeInputs, true);
        toggle(weeklyModeInputs, false);
        toggle(selectedDaysCount, false);
      } else {
        toggle(scheduleInputs, false);
        // Reset weekly mode
        document.querySelectorAll('.day-checkbox').forEach(cb => {
          cb.checked = false;
          const timeInput = $('time_' + cb.value);
          if (timeInput) {
            timeInput.disabled = true;
            timeInput.value = '';
          }
        });
      }
    });
    
    // Event listener cho chế độ lên lịch
    scheduleMode.addEventListener('change', () => {
      if (scheduleMode.value === 'once') {
        toggle(onceModeInputs, true);
        toggle(weeklyModeInputs, false);
        toggle(selectedDaysCount, false);
      } else {
        toggle(onceModeInputs, false);
        toggle(weeklyModeInputs, true);
        updateSelectedDaysCount();
      }
    });
    
    // Event listeners cho checkbox các ngày
    document.querySelectorAll('.day-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const dayValue = checkbox.value;
        const timeInput = $('time_' + dayValue);
        
        if (checkbox.checked) {
          timeInput.disabled = false;
          if (!timeInput.value) {
            timeInput.value = '09:00'; // Giờ mặc định
          }
        } else {
          timeInput.disabled = true;
          timeInput.value = '';
        }
        
        updateSelectedDaysCount();
      });
    });
    
    // Event listener cho select all
    selectAllGroups.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = selectAllGroups.checked);
      updateSelectedGroupsCount();
    });

    // Event listeners cho trang danh sách bài đăng đã lên lịch
    scheduleNewPostBtn.addEventListener('click', () => {
      // Nếu đã có nhóm được chọn, quay về step 2 (soạn nội dung)
      // Nếu chưa có nhóm, quay về step 1 (chọn nhóm)
      if (selectedGroups.length > 0) {
        showFeature2Step(step2_2);
        // Reset nội dung form nhưng giữ nhóm đã chọn
        postContent.value = '';
        postImages.value = '';
        enableSchedule.checked = false;
        toggle(scheduleInputs, false);
        scheduleMode.value = 'once';
        toggle(onceModeInputs, true);
        toggle(weeklyModeInputs, false);
        toggle(selectedDaysCount, false);
        document.querySelectorAll('.day-checkbox').forEach(cb => {
          cb.checked = false;
          const timeInput = $('time_' + cb.value);
          if (timeInput) {
            timeInput.disabled = true;
            timeInput.value = '';
          }
        });
        updateCharCount();
        checkPostImageCount();
        
        // Cập nhật hiển thị nhóm đã chọn
        const groupNames = selectedGroups.map(g => g.name).join(', ');
        selectedGroupsDisplay.textContent = `Sẽ đăng bài vào ${selectedGroups.length} nhóm: ${groupNames}`;
      } else {
        showFeature2Step(step2_1);
        // Reset toàn bộ form
        toggle(resultSection2, false);
        toggle(actionsBox2, false);
        nickSelect2.selectedIndex = 0;
        postContent.value = '';
        postImages.value = '';
        groupList2.innerHTML = '';
        selectedGroups = [];
        enableSchedule.checked = false;
        toggle(scheduleInputs, false);
        scheduleMode.value = 'once';
        toggle(onceModeInputs, true);
        toggle(weeklyModeInputs, false);
        toggle(selectedDaysCount, false);
        document.querySelectorAll('.day-checkbox').forEach(cb => {
          cb.checked = false;
          const timeInput = $('time_' + cb.value);
          if (timeInput) {
            timeInput.disabled = true;
            timeInput.value = '';
          }
        });
        updateCharCount();
        checkPostImageCount();
      }
    });

    backToHomeBtn.addEventListener('click', () => {
      showPage(homePage);
    });

    // Toggle hiển thị mật khẩu
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      
      if (type === 'text') {
        toggle(eyeOpen, false);
        toggle(eyeClosed, true);
      } else {
        toggle(eyeOpen, true);
        toggle(eyeClosed, false);
      }
    });
    // Xử lý đăng nhập
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = $('username').value.trim();
      const password = $('password').value;

      loginBtn.disabled = true;
      toggle(loginBtnText, false);
      toggle(loginSpinner, true);
      toggle(loginError, false);

      await new Promise(resolve => setTimeout(resolve, 1000));

              // Check admin login
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
          // Show loading
          toggle(loginError, false);
          showLoginMessage('Đang đăng nhập...', 'text-blue-600');
          
          setTimeout(() => {
            sessionStorage.setItem('zalo_scanner_logged_in', 'true');
            localStorage.setItem('currentUser', JSON.stringify({
              id: 'admin',
              username: ADMIN_USERNAME,
              fullName: 'Administrator',
              isAdmin: true
            }));
            
            // Check if redirect to admin panel
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('redirect') === 'admin') {
              window.location.href = '/admin';
              return;
            }
            
            showMainApp();
            // Show admin button for admin
            toggle($('adminBtn'), true);
            loginForm.reset();
          }, 800);
        } else {
          // Initialize Supabase if not done yet
          if (!window.supabaseService || !window.supabaseService.initialized) {
            if (typeof CONFIG !== 'undefined' && CONFIG.supabase) {
              await window.supabaseService.init(CONFIG.supabase);
            }
          }
          
          // Show loading
          toggle(loginError, false);
          showLoginMessage('Đang xác thực...', 'text-blue-600');
          
          // Check user login from Supabase
          const authResult = await window.supabaseService.authenticate(username, password);
          
          if (authResult.success) {
            showLoginMessage('Đăng nhập thành công!', 'text-green-600');
            
            setTimeout(() => {
              sessionStorage.setItem('zalo_scanner_logged_in', 'true');
              localStorage.setItem('currentUser', JSON.stringify({
                ...authResult.user,
                isAdmin: false
              }));
              showMainApp();
              // Update nick selects with user's nicks
              updateNickSelects(authResult.user.nicks || []);
              loginForm.reset();
            }, 600);
          } else {
            const errorMsg = $('loginError').querySelector('p');
            errorMsg.textContent = authResult.message || 'Tên đăng nhập hoặc mật khẩu không đúng!';
            errorMsg.className = 'text-sm text-red-600';
            toggle(loginError, true);
            loginForm.classList.add('shake');
            setTimeout(() => loginForm.classList.remove('shake'), 500);
          }
        }

      loginBtn.disabled = false;
      toggle(loginBtnText, true);
      toggle(loginSpinner, false);
    });

    // Đăng xuất
    logoutBtn.addEventListener('click', () => {
      if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
        sessionStorage.removeItem('zalo_scanner_logged_in');
        localStorage.removeItem('currentUser');
        showLoginPage();
        showPage(homePage);
        toggle(step1, true);
        toggle(step2, false);
        toggle(resultSec, false);
        toggle(actionsBox, false);
        toggle($('adminBtn'), false);
        nickSelect.selectedIndex = 0;
        messageTxt.value = '';
        imagesInput.value = '';
        groupList.innerHTML = '';
        groupSelect.innerHTML = '';
        checkImageCount();
      }
    });
    
    // Admin button
    $('adminBtn').addEventListener('click', () => {
      window.location.href = '/admin';
    });

    // Ngăn zoom khi double tap trên iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // ---- CACHE EVENT LISTENERS ----
    
    // Nick select change events để tự động load cache nếu có
    nickSelect.addEventListener('change', () => {
      const nick = nickSelect.value;
      
      // Reset UI trước
      toggle(resultSec, false);
      toggle(actionsBox, false);
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';
      
      // Cập nhật cache display (sẽ ẩn nếu chưa chọn nick)
      updateCacheDisplay(1, nick);
      
      if (nick && nick !== '') {
        // Tự động load cache nếu có
        const success = loadGroupsFromCache(1, nick);
        
        if (success) {
          console.log('Auto-loaded groups from cache for feature 1');
        }
      }
    });

    nickSelect2.addEventListener('change', () => {
      const nick = nickSelect2.value;
      
      // Reset UI trước
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      groupList2.innerHTML = '';
      selectedGroups = [];
      
      // Cập nhật cache display (sẽ ẩn nếu chưa chọn nick)
      updateCacheDisplay(2, nick);
      
      if (nick && nick !== '') {
        // Tự động load cache nếu có
        const success = loadGroupsFromCache(2, nick);
        
        if (success) {
          console.log('Auto-loaded groups from cache for feature 2');
        }
      }
    });

    nickSelect3.addEventListener('change', () => {
      const nick = nickSelect3.value;
      
      // Reset UI trước
      toggle(resultSection3, false);
      toggle(actionsBox3, false);
      sourceGroupList.innerHTML = '';
      targetGroupList.innerHTML = '';
      sourceGroups = [];
      targetGroups = [];
      
      // Cập nhật cache display (sẽ ẩn nếu chưa chọn nick)
      updateCacheDisplay(3, nick);
      
      if (nick && nick !== '') {
        // Tự động load cache nếu có
        const success = loadGroupsFromCache(3, nick);
        
        if (success) {
          console.log('Auto-loaded groups from cache for feature 3');
        }
      }
    });



    // Refresh button events - force new scan by clearing cache
    refreshBtn1.addEventListener('click', () => {
      const nick = nickSelect.value;
      if (nick) {
        clearGroupCache(nick);
        updateCacheDisplay(1, nick);
        // Trigger scan
        scanBtn.click();
      }
    });

    refreshBtn2.addEventListener('click', () => {
      const nick = nickSelect2.value;
      if (nick) {
        clearGroupCache(nick);
        updateCacheDisplay(2, nick);
        // Trigger scan
        scanBtn2.click();
      }
    });

    refreshBtn3.addEventListener('click', () => {
      const nick = nickSelect3.value;
      if (nick) {
        clearGroupCache(nick);
        updateCacheDisplay(3, nick);
        // Trigger scan
        scanBtn3.click();
      }
    });

    // ---- FEATURE 1: Quét nhóm ----
    scanBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      // Nếu có cache, xác nhận có muốn quét lại không
      const cachedGroups = getGroupCache(nick);
      if (cachedGroups) {
        const refreshConfirm = confirm(`Nick "${nick}" đã có ${cachedGroups.length} nhóm trong cache. Bạn có chắc muốn quét lại từ server không? (sẽ mất thời gian)`);
        if (!refreshConfirm) {
          return; // Người dùng không muốn quét lại
        }
      }

      scanBtn.disabled = true;
      toggle(spinner, true);
      overlayText.innerHTML = 'Việc quét nhóm có thể lâu hơn 1 phút, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';

      try {
        // Refresh webhooks from database first
        console.log('🔄 Refreshing user data and webhooks from database...');
        const refreshResult = await refreshUserData();
        
        if (!refreshResult.success) {
          console.warn('⚠️ Failed to refresh user data, using cached webhooks:', refreshResult.error);
        }
        
        // Get the latest webhooks
        webhooks = getCurrentWebhooks();
        const currentScanWebhook = webhooks.scanWebhook;
        
        console.log('Starting group scan (feature 1) with webhook:', currentScanWebhook);
        console.log('Nick selected:', nick);
        
        // Validate webhook URL
        if (!currentScanWebhook || currentScanWebhook === '') {
          throw new Error('WEBHOOK_NOT_CONFIGURED: Scan webhook is not configured for this user. Please contact admin.');
        }
        
        // Use enhanced fetch with better error handling
        const res = await fetchWithTimeout(currentScanWebhook, { 
          method: 'POST', 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ nick })
        }, 150000); // 2.5 minutes timeout
        
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        const responseText = await res.text();
        console.log('Raw response text:', responseText);
        
        let raw;
        try {
          raw = JSON.parse(responseText);
        } catch (parseError) {
          // Try to recover from non-strict JSON or text results by extracting JSON substring
          try {
            const startIdx = responseText.indexOf('{');
            const endIdx = responseText.lastIndexOf('}');
            const arrayStartIdx = responseText.indexOf('[');
            const arrayEndIdx = responseText.lastIndexOf(']');
            let candidate = '';
            if (arrayStartIdx !== -1 && arrayEndIdx !== -1 && (arrayEndIdx - arrayStartIdx) > (endIdx - startIdx)) {
              candidate = responseText.slice(arrayStartIdx, arrayEndIdx + 1);
            } else if (startIdx !== -1 && endIdx !== -1) {
              candidate = responseText.slice(startIdx, endIdx + 1);
            }
            if (candidate) {
              raw = JSON.parse(candidate);
            } else {
              throw parseError;
            }
          } catch (recoverErr) {
            console.error('JSON parse error:', parseError);
            console.error('Invalid JSON response:', responseText);
            throw new Error('Invalid JSON response from webhook');
          }
        }
        
        console.log('Parsed response:', raw);

        let groups = [];
        
        // Handle n8n's nested { "response": { "body": [...] } } structure
        if (raw && raw.response && Array.isArray(raw.response.body)) {
          groups = raw.response.body.map(item => ({
            id: item.groupId || item.groupid || item.id || item.group_id,
            name: item.name || item.groupName || item.group_name || 'Không tên'
          }));
        }
        // Handle direct array format from n8n
        else if (Array.isArray(raw)) {
          groups = raw.filter(item => {
            // Support multiple field names for group ID
            return item.groupId || item.groupid || item.id || item.group_id;
          }).map(item => ({
            id: item.groupId || item.groupid || item.id || item.group_id,
            name: item.name || item.groupName || item.group_name || 'Không tên'
          }));
        } 
        // Handle object with groups property
        else if (raw && typeof raw === 'object' && raw.groups) {
          if (Array.isArray(raw.groups)) {
            groups = raw.groups.map(g => {
              if (typeof g === 'string') {
                return { id: g, name: g };
              }
              return {
                id: g.groupId || g.groupid || g.id || g.group_id,
                name: g.name || g.groupName || g.group_name || g.id || 'Không tên'
              };
            });
          }
        }
        // Handle single object format
        else if (raw && typeof raw === 'object' && (raw.groupId || raw.id)) {
          groups = [{
            id: raw.groupId || raw.id,
            name: raw.name || raw.groupName || 'Không tên'
          }];
        }

        console.log('Processed groups:', groups);

        // Lưu kết quả vào cache
        setGroupCache(nick, groups);
        updateCacheDisplay(1, nick);

        if (groups.length === 0) {
          toggle(emptyMsg, true);
          console.log('No groups found in response');
        } else {
          toggle(emptyMsg, false);
          groups.forEach(g => {
            groupList.insertAdjacentHTML('beforeend', `<li class="break-words">${g.name}</li>`);
            groupSelect.insertAdjacentHTML('beforeend', `<option value="${g.id}">${g.name}</option>`);
          });
          toggle(actionsBox, true);
          console.log(`Successfully loaded ${groups.length} groups - saved to cache`);
        }
        toggle(resultSec, true);
        
        // Hide overlay on success
        toggle(overlay, false);
      } catch (err) {
        console.error('Error during group scan:', err);
        console.error('Error stack:', err.stack);
        
        // Use enhanced error handler with session expiry detection
        const { isSessionExpired, userMessage } = handleWebhookError(err, 'scan_groups_feature1', nick);
        
        // Show error overlay with appropriate message
        showErrorOverlay(userMessage, isSessionExpired);
        
      } finally {
        scanBtn.disabled = false;
        toggle(spinner, false);
        // Overlay will be hidden in success block or by showErrorOverlay in catch block
      }
    });

    // ---- FEATURE 1: Chuyển sang bước 2 ----
    nextBtn.addEventListener('click', () => {
      const groupId = groupSelect.value;
      if (!groupId) return alert('Vui lòng chọn một nhóm.');
      currentGroup = { id: groupId, name: groupSelect.options[groupSelect.selectedIndex].text };
      chosenGroup.textContent = `Sẽ gửi đến: ${currentGroup.name}`;
      toggle(step1, false);
      toggle(step2, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- FEATURE 1: Quay lại ----
    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggle(step2, false);
      toggle(step1, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
        // ---- FEATURE 1: Gửi tin nhắn ----
        sendMsgBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      const text = messageTxt.value.trim();
      const files = imagesInput.files;
      if (!text && files.length === 0) return alert('Vui lòng nhập nội dung hoặc chọn ảnh.');
      if (files.length > 3) return alert('Chỉ tải tối đa 3 ảnh.');

      sendMsgBtn.disabled = true;
      toggle(spinnerSend, true);
      overlayText.innerHTML = 'Đang tiến hành gửi tin nhắn, vui lòng chờ...';
      toggle(overlay, true);

      try {
        const imageUrls = [];
        if (files.length > 0) {
          overlayText.innerHTML = `Đang tải lên ${files.length} ảnh...`;
          for (const file of files) {
            const formData = new FormData();
            formData.append('image', file);
            
            const uploadRes = await fetch('/api/upload', {
              method: 'POST',
              body: formData,
            });

            if (!uploadRes.ok) {
              const errorData = await uploadRes.json();
              throw new Error(`Tải ảnh lên thất bại: ${errorData.error || uploadRes.statusText}`);
            }
            
            const { imageUrl } = await uploadRes.json();
            imageUrls.push(imageUrl);
          }
        }
        
        overlayText.innerHTML = 'Đang gửi tin nhắn tới webhook...';
        
        // Get the latest webhooks
        webhooks = getCurrentWebhooks();
        const currentSendWebhook = webhooks.sendWebhook;
        
        console.log('Sending message with webhook:', currentSendWebhook);
        
        // Validate webhook URL
        if (!currentSendWebhook || currentSendWebhook === '') {
          throw new Error('WEBHOOK_NOT_CONFIGURED: Send webhook is not configured for this user. Please contact admin.');
        }
        
        const payload = {
          nick,
          groupId: currentGroup.id,
          groupName: currentGroup.name,
          text,
          imageUrls, // Send array of URLs
        };

        const res = await fetch(currentSendWebhook, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload) 
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Send message error:', errorText);
          throw new Error(`Webhook server returned status ${res.status}`);
        }
        
        alert('Đã gửi thành công!');
        messageTxt.value = '';
        imagesInput.value = '';
        checkImageCount();
        
      } catch (err) {
        console.error('Error sending message:', err);
        alert(`Gửi thất bại: ${err.message}`);
      } finally {
        sendMsgBtn.disabled = false;
        toggle(spinnerSend, false);
        toggle(overlay, false);
      }
    });
// ---- FEATURE 2: Quét nhóm cho đăng bài ----
    scanBtn2.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      // Nếu có cache, xác nhận có muốn quét lại không
      const cachedGroups = getGroupCache(nick);
      if (cachedGroups) {
        const refreshConfirm = confirm(`Nick "${nick}" đã có ${cachedGroups.length} nhóm trong cache. Bạn có chắc muốn quét lại từ server không? (sẽ mất thời gian)`);
        if (!refreshConfirm) {
          return; // Người dùng không muốn quét lại
        }
      }

      scanBtn2.disabled = true;
      toggle(spinner2, true);
      overlayText.innerHTML = 'Việc quét nhóm có thể lâu hơn 1 phút, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      groupList2.innerHTML = '';
      selectedGroups = [];

      try {
        // Refresh webhooks from database first
        console.log('🔄 Refreshing user data and webhooks from database...');
        const refreshResult = await refreshUserData();
        
        if (!refreshResult.success) {
          console.warn('⚠️ Failed to refresh user data, using cached webhooks:', refreshResult.error);
        }
        
        // Get the latest webhooks
        webhooks = getCurrentWebhooks();
        const currentScanWebhook = webhooks.scanWebhook;
        
        console.log('Starting group scan for feature 2 with webhook:', currentScanWebhook);
        console.log('Nick selected:', nick);
        
        // Validate webhook URL
        if (!currentScanWebhook || currentScanWebhook === '') {
          throw new Error('WEBHOOK_NOT_CONFIGURED: Scan webhook is not configured for this user. Please contact admin.');
        }
        
        // Use enhanced fetch with better error handling
        const res = await fetchWithTimeout(currentScanWebhook, { 
          method: 'POST', 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ nick })
        }, 150000); // 2.5 minutes timeout
        
        // Read response as text first to handle empty responses
        const responseText = await res.text();
        console.log('Raw response text:', responseText);
        
        // Check if response is empty
        if (!responseText || responseText.trim() === '') {
          throw new Error('EMPTY_RESPONSE: Webhook returned empty response. Nick may need to login again.');
        }
        
        // Try to parse JSON safely
        let raw;
        try {
          raw = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response text:', responseText.substring(0, 500));
          throw new Error('INVALID_JSON: Webhook returned invalid JSON. Response: ' + responseText.substring(0, 100));
        }
        
        console.log('Parsed response:', raw);

        let groups = [];
        
        // Handle n8n's nested { "response": { "body": [...] } } structure
        if (raw && raw.response && Array.isArray(raw.response.body)) {
          groups = raw.response.body.map(item => ({
            id: item.groupId || item.groupid || item.id || item.group_id,
            name: item.name || item.groupName || item.group_name || 'Không tên'
          }));
        }
        // Handle direct array format
        else if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ 
            id: i.groupId || i.groupid || i.id, 
            name: i.name || i.groupName || 'Không tên' 
          }));
        } 
        // Handle object with groups property
        else if (raw && raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => 
            typeof g === 'string' ? { id: g, name: g } : { 
              id: g.id || g.groupId, 
              name: g.name || g.groupName || g.id 
            }
          );
        }

        // Lưu kết quả vào cache
        setGroupCache(nick, groups);
        updateCacheDisplay(2, nick);

        if (groups.length === 0) {
          toggle(emptyMsg2, true);
        } else {
          toggle(emptyMsg2, false);
          groups.forEach((g, index) => {
            groupList2.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateSelectedGroupsCount()"
                >
                <label for="group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
          toggle(actionsBox2, true);
        }
        toggle(resultSection2, true);
        updateSelectedGroupsCount();
        
        // Hide overlay on success
        toggle(overlay, false);
      } catch (err) {
        console.error('Error during group scan (feature 2):', err);
        console.error('Error stack:', err.stack);
        
        // Use enhanced error handler with session expiry detection
        const { isSessionExpired, userMessage } = handleWebhookError(err, 'scan_groups_feature2', nick);
        
        // Show error overlay with appropriate message
        showErrorOverlay(userMessage, isSessionExpired);
        
      } finally {
        scanBtn2.disabled = false;
        toggle(spinner2, false);
        // Overlay will be hidden in success block or by showErrorOverlay in catch block
      }
    });

    // ---- FEATURE 2: Chuyển sang bước chọn loại bài đăng ----
    nextBtn2.addEventListener('click', () => {
      if (selectedGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm.');
      
      const groupNames = selectedGroups.map(g => g.name).join(', ');
      $('selectedGroupsText2').textContent = `${selectedGroups.length} nhóm được chọn: ${groupNames}`;
      
      // Cập nhật số lượng bài cũ
      updateOldPostCount();
      
      showFeature2Step($('step2_1_5'));
    });

    // ---- FEATURE 2: Quay lại từ step 2 ----
    backBtn2.addEventListener('click', () => {
      console.log('Back button clicked, resetting form state');
      
      // Reset selectedOldPost khi quay lại
      selectedOldPost = null;
      
      // Reset trạng thái hiển thị ảnh
      const postImagesInput = $('postImages');
      const postImagesLabel = postImagesInput.previousElementSibling;
      if (postImagesInput) {
        postImagesInput.style.display = 'block';
        postImagesInput.value = '';
      }
      if (postImagesLabel) {
        postImagesLabel.style.display = 'block';
      }
      
      // Xóa preview ảnh cũ nếu có
      const oldImagesPreview = $('oldImagesPreview');
      if (oldImagesPreview) {
        oldImagesPreview.remove();
      }
      
      // Reset trạng thái ảnh
      const imageStatus = $('postImageStatus');
      if (imageStatus) {
        toggle(imageStatus, false);
      }
      
      // Reset form content
      if (postContent) {
        postContent.value = '';
      }
      
      // Cập nhật lại số lượng bài cũ
      updateOldPostCount();
      
      showFeature2Step($('step2_1_5'));
    });

    // ---- FEATURE 2: Quay lại từ step 1.5 ----
    $('backToGroupSelection').addEventListener('click', () => {
      // Reset toàn bộ state của tính năng "sử dụng bài cũ"
      resetOldPostFeatureState();
      
      // Reset lịch đăng bài
      enableSchedule.checked = false;
      toggle(scheduleInputs, false);
      scheduleMode.value = 'once';
      document.querySelectorAll('.day-checkbox').forEach(cb => {
        cb.checked = false;
        const timeInput = $('time_' + cb.value);
        if (timeInput) {
          timeInput.disabled = true;
          timeInput.value = '';
        }
      });
      
      showFeature2Step(step2_1);
    });

    // ---- FEATURE 2: Chọn tạo bài mới ----
    document.addEventListener('click', (e) => {
      if (e.target.closest('#createNewPostCard')) {
        selectedOldPost = null;
        showFeature2Step(step2_2);
        
        // Reset form
        postContent.value = '';
        postImages.value = '';
        
        // Hiển thị lại input file nếu đang ẩn
        const postImagesInput = $('postImages');
        const postImagesLabel = postImagesInput.previousElementSibling;
        postImagesInput.style.display = 'block';
        postImagesLabel.style.display = 'block';
        
        // Xóa preview ảnh cũ nếu có
        const oldImagesPreview = $('oldImagesPreview');
        if (oldImagesPreview) {
          oldImagesPreview.remove();
        }
        
        // Reset trạng thái ảnh
        const imageStatus = $('postImageStatus');
        toggle(imageStatus, false);
        
        checkPostImageCount();
        updateCharCount();
        
        // Cập nhật hiển thị nhóm đã chọn
        const groupNames = selectedGroups.map(g => g.name).join(', ');
        selectedGroupsDisplay.textContent = `Sẽ đăng bài vào ${selectedGroups.length} nhóm: ${groupNames}`;
      }
    });

    // ---- FEATURE 2: Chọn sử dụng bài cũ ----
    function initializeUseOldPostCard() {
      const useOldPostCard = $('useOldPostCard');
      if (!useOldPostCard) {
        console.error('useOldPostCard element not found!');
        return;
      }
      
      console.log('Initializing useOldPostCard event listener...');
      
      // Đánh dấu đã khởi tạo để tránh khởi tạo lại
      if (useOldPostCard.dataset.initialized === 'true') {
        console.log('useOldPostCard already initialized, skipping...');
        return;
      }
      
      // Gắn event listener mới
      useOldPostCard.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('=== Use old post clicked ===');
        console.log('Saved posts length:', savedPosts.length);
        console.log('Current selectedOldPost:', selectedOldPost);
        console.log('Event target:', e.target);
        console.log('Card element:', this);
        console.log('Card classes:', this.className);
        console.log('Card style.pointerEvents:', this.style.pointerEvents);
        console.log('Card style.opacity:', this.style.opacity);
        
        // Kiểm tra xem card có bị disabled không
        if (this.classList.contains('disabled') || this.style.pointerEvents === 'none') {
          console.log('Card is disabled, ignoring click');
          return;
        }
        // Đảm bảo card không bị disabled
        this.classList.remove('disabled');
        this.style.pointerEvents = '';
        this.style.opacity = '';
        // Thêm dữ liệu mẫu nếu chưa có bài viết nào
        if (savedPosts.length === 0) {
          console.log('No saved posts, creating sample posts...');
          // Tạo một số bài viết mẫu để test
          savedPosts = [
            {
              id: 'sample_1',
              content: 'Xin chào các bạn! Hôm nay mình muốn chia sẻ một số tips hay về marketing online. Các bạn có những kinh nghiệm gì thú vị không?',
              images: [
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjM2NmYxIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMTwvdGV4dD48L3N2Zz4=',
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjOGI1Y2Y2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMjwvdGV4dD48L3N2Zz4=',
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWM0ODk5Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMzwvdGV4dD48L3N2Zz4=',
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDU5NjY5Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggNDwvdGV4dD48L3N2Zz4='
              ],
              imageCount: 4,
              createdAt: new Date().toISOString()
            },
            {
              id: 'sample_2',
              content: 'Chúc mọi người một ngày mới tràn đầy năng lượng! 💪✨ Hôm nay có kế hoạch gì thú vị không ạ?',
              images: [
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjU5ZTBiIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TYW5nIDE8L3RleHQ+PC9zdmc+',
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTBiOTgxIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TYW5nIDI8L3RleHQ+PC9zdmc+'
              ],
              imageCount: 2,
              createdAt: new Date(Date.now() - 86400000).toISOString() // 1 ngày trước
            }
          ];
          localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
          updateOldPostCount();
          console.log('Created sample posts:', savedPosts);
        }
        
        // Hiển thị modal chọn bài cũ
        console.log('About to show old posts list');
        showOldPostsList();
        console.log('About to toggle modal');
        toggle($('oldPostModal'), true);
        console.log('Modal should be visible now');
      });
      
      // Đánh dấu đã khởi tạo
      useOldPostCard.dataset.initialized = 'true';
      console.log('useOldPostCard event listener initialized successfully!');
    }
    
    // Backup event listener sử dụng event delegation (để đảm bảo hoạt động trong mọi trường hợp)
    document.addEventListener('click', function(e) {
      if (e.target.closest('#useOldPostCard')) {
        const useOldPostCard = e.target.closest('#useOldPostCard');
        
        // Chỉ dùng backup khi direct listener không hoạt động (kiểm tra sau 100ms)
        if (useOldPostCard.dataset.initialized !== 'true') {
          console.log('Direct listener not initialized, using backup event listener');
          e.preventDefault();
          e.stopPropagation();
          
          console.log('=== Use old post clicked (backup) ===');
          console.log('Saved posts length:', savedPosts.length);
          
          // Đảm bảo card không bị disabled
          useOldPostCard.classList.remove('disabled');
          useOldPostCard.style.pointerEvents = '';
          useOldPostCard.style.opacity = '';
          
          // Thêm dữ liệu mẫu nếu chưa có bài viết nào
          if (savedPosts.length === 0) {
            console.log('No saved posts, creating sample posts... (backup)');
            savedPosts = [
              {
                id: 'sample_1',
                content: 'Xin chào các bạn! Hôm nay mình muốn chia sẻ một số tips hay về marketing online. Các bạn có những kinh nghiệm gì thú vị không?',
                images: [
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjM2NmYxIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMTwvdGV4dD48L3N2Zz4=',
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjOGI1Y2Y2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMjwvdGV4dD48L3N2Zz4=',
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWM0ODk5Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggMzwvdGV4dD48L3N2Zz4=',
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDU5NjY5Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5B4bqjbmggNDwvdGV4dD48L3N2Zz4='
                ],
                imageCount: 4,
                createdAt: new Date().toISOString()
              },
              {
                id: 'sample_2',
                content: 'Chúc mọi người một ngày mới tràn đầy năng lượng! 💪✨ Hôm nay có kế hoạch gì thú vị không ạ?',
                images: [
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjU5ZTBiIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TYW5nIDE8L3RleHQ+PC9zdmc+',
                  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTBiOTgxIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TYW5nIDI8L3RleHQ+PC9zdmc+'
                ],
                imageCount: 2,
                createdAt: new Date(Date.now() - 86400000).toISOString()
              }
            ];
            localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
            updateOldPostCount();
          }
          
          // Hiển thị modal chọn bài cũ
          showOldPostsList();
          toggle($('oldPostModal'), true);
        } else {
          console.log('Direct listener already initialized, ignoring backup');
        }
      }
    });

    // ---- MODAL EVENTS ----
    document.addEventListener('click', (e) => {
      // Đóng modal chọn bài cũ
      if (e.target.closest('#closeOldPostModal')) {
        toggle($('oldPostModal'), false);
      }
      
      // Đóng modal xem trước
      if (e.target.closest('#closePreviewModal')) {
        toggle($('previewModal'), false);
      }
      
      // Chọn bài viết từ preview
      if (e.target.closest('#selectThisPost')) {
        if (selectedOldPost) {
          toggle($('previewModal'), false);
          selectOldPost(savedPosts.findIndex(post => post.id === selectedOldPost.id));
        }
      }
      
      // Hủy preview
      if (e.target.closest('#cancelPreview')) {
        toggle($('previewModal'), false);
        selectedOldPost = null;
      }
      
      // Xử lý các nút trong danh sách bài cũ và nút đổi ảnh
      const actionButton = e.target.closest('[data-action]');
      if (actionButton) {
        const action = actionButton.dataset.action;
        const index = parseInt(actionButton.dataset.index);
        
        if (action === 'preview') {
          console.log('Preview post at index:', index);
          previewOldPost(index);
        } else if (action === 'select') {
          console.log('Select post at index:', index);
          selectOldPost(index);
        } else if (action === 'switchToNewImages') {
          console.log('Switch to new images');
          switchToNewImages();
        }
      }
    });

    // ---- FEATURE 2: Đăng bài ----
    publishBtn.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      const content = postContent.value.trim();
      const files = postImages.files;

      if (selectedGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm để đăng bài.');
      if (!selectedOldPost && !content && files.length === 0) return alert('Vui lòng nhập nội dung hoặc tải ảnh cho bài viết mới.');
      if (selectedOldPost && !content && (!selectedOldPost.images || selectedOldPost.images.length === 0)) return alert('Bài viết cũ không có nội dung. Vui lòng nhập nội dung.');
      if (!selectedOldPost && files.length < 4) return alert('Vui lòng tải lên đủ 4 ảnh cho bài viết mới.');

      let schedulesData = [];
      if (enableSchedule.checked) {
        if (scheduleMode.value === 'once') {
          if (!scheduleDate.value || !scheduleTime.value) return alert('Vui lòng chọn ngày và giờ hẹn đăng bài.');
          schedulesData.push({ type: 'once', date: scheduleDate.value, time: scheduleTime.value });
        } else {
          const checkedDays = document.querySelectorAll('.day-checkbox:checked');
          if (checkedDays.length === 0) return alert('Vui lòng chọn ít nhất một ngày trong tuần.');
          for (const cb of checkedDays) {
            const timeInput = $(`time_${cb.value}`);
            if (!timeInput.value) return alert(`Vui lòng chọn giờ cho ${cb.nextElementSibling.textContent}.`);
            schedulesData.push({ type: 'weekly', dayOfWeek: parseInt(cb.value), time: timeInput.value, dayName: cb.nextElementSibling.textContent });
          }
        }
      }

      publishBtn.disabled = true;
      toggle(publishSpinner, true);
      overlayText.innerHTML = 'Đang chuẩn bị bài đăng...';
      toggle(overlay, true);

      try {
        let imageUrls = [];
        if (selectedOldPost && selectedOldPost.images && selectedOldPost.images.length > 0) {
          imageUrls = selectedOldPost.images;
        } else if (files.length > 0) {
          overlayText.innerHTML = `Đang tải lên ${files.length} ảnh...`;
          const uploadPromises = Array.from(files).map(async (file) => {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch('/api/upload', { method: 'POST', body: formData });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({ error: 'Không thể đọc phản hồi' }));
              throw new Error(`Tải ảnh '${file.name}' thất bại: ${errorData.error}`);
            }
            const result = await response.json();
            if (!result.imageUrl) {
              throw new Error('Phản hồi từ server không chứa URL ảnh.');
            }
            return result.imageUrl;
          });
          imageUrls = await Promise.all(uploadPromises);
        }

        // Get the latest webhooks
        webhooks = getCurrentWebhooks();
        const currentPostWebhook = webhooks.postWebhook;
        
        console.log('Posting to groups with webhook:', currentPostWebhook);
        
        // Validate webhook URL
        if (!currentPostWebhook || currentPostWebhook === '') {
          throw new Error('WEBHOOK_NOT_CONFIGURED: Post webhook is not configured for this user. Please contact admin.');
        }
        
        const basePayload = { nick, groups: selectedGroups, content, imageUrls };
        let successCount = 0;
        const schedulesToRun = schedulesData.length > 0 ? schedulesData : [{ type: 'immediate' }];

        for (let i = 0; i < schedulesToRun.length; i++) {
          overlayText.innerHTML = `Đang gửi yêu cầu... (${i + 1}/${schedulesToRun.length})`;
          const payload = { ...basePayload, schedule: schedulesToRun[i] };
          const webhookResponse = await fetch(currentPostWebhook, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (webhookResponse.ok) successCount++;
          else console.error('Webhook lỗi:', await webhookResponse.text());
        }

        if (successCount === 0) throw new Error('Tất cả các yêu cầu đăng bài đều thất bại.');

        const postDataForStorage = { content, groups: selectedGroups, imageUrls, imageCount: imageUrls.length, schedules: schedulesData, totalSchedules: schedulesData.length, successCount, createdAt: new Date().toISOString(), nick };
        
        if (!selectedOldPost && (content || imageUrls.length > 0)) {
           savePostForReuse(postDataForStorage);
        }
        
        saveScheduledPost(postDataForStorage);
        showNewPostDetails(postDataForStorage);
        showFeature2Step(step2_3);

      } catch (error) {
        console.error('Lỗi khi đăng bài:', error);
        alert('Đăng bài thất bại: ' + error.message);
      } finally {
        publishBtn.disabled = false;
        toggle(publishSpinner, false);
        toggle(overlay, false);
        resetOldPostFeatureState();
      }
    });


    // Also, we need to fix the `savePostForReuse` to accept `imageUrls`
    function savePostForReuse(postData) {
      const existingIndex = savedPosts.findIndex(post => post.content === postData.content);
      if (existingIndex !== -1) {
        savedPosts.splice(existingIndex, 1);
      }
      savedPosts.unshift({
        id: Date.now(),
        content: postData.content,
        images: postData.imageUrls || [], // Changed from postData.images to postData.imageUrls
        imageCount: postData.imageCount || 0,
        createdAt: new Date().toISOString(),
        nick: postData.nick
      });
      if (savedPosts.length > 5) {
        savedPosts = savedPosts.slice(0, 5);
      }
      localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
      updateOldPostCount();
    }

    // ---- FEATURE 3: Quét nhóm cho mời thành viên ----
    scanBtn3.addEventListener('click', async () => {
      const nick = nickSelect3.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      // Nếu có cache, xác nhận có muốn quét lại không
      const cachedGroups = getGroupCache(nick);
      if (cachedGroups) {
        const refreshConfirm = confirm(`Nick "${nick}" đã có ${cachedGroups.length} nhóm trong cache. Bạn có chắc muốn quét lại từ server không? (sẽ mất thời gian)`);
        if (!refreshConfirm) {
          return; // Người dùng không muốn quét lại
        }
      }

      scanBtn3.disabled = true;
      toggle(spinner3, true);
      overlayText.innerHTML = 'Đang quét nhóm, có thể lâu hơn 5 phút, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSection3, false);
      toggle(actionsBox3, false);
      sourceGroupList.innerHTML = '';
      targetGroupList.innerHTML = '';
      toggle(emptySourceMsg, false);
      toggle(emptyTargetMsg, false);
      sourceGroups = [];
      targetGroups = [];

      try {
        // Refresh webhooks from database first
        console.log('🔄 Refreshing user data and webhooks from database...');
        const refreshResult = await refreshUserData();
        
        if (!refreshResult.success) {
          console.warn('⚠️ Failed to refresh user data, using cached webhooks:', refreshResult.error);
        }
        
        // Get the latest webhooks
        webhooks = getCurrentWebhooks();
        const currentScanWebhook = webhooks.scanWebhook;
        
        console.log('Starting group scan (feature 3) with webhook:', currentScanWebhook);
        console.log('Nick selected:', nick);
        
        // Validate webhook URL
        if (!currentScanWebhook || currentScanWebhook === '') {
          throw new Error('WEBHOOK_NOT_CONFIGURED: Scan webhook is not configured for this user. Please contact admin.');
        }
        
        // Use enhanced fetch with better error handling
        const res = await fetchWithTimeout(currentScanWebhook, { 
          method: 'POST', 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ nick })
        }, 150000); // 2.5 minutes timeout
        
        // Read response as text first to handle empty responses
        const responseText = await res.text();
        console.log('Raw response text:', responseText);
        
        // Check if response is empty
        if (!responseText || responseText.trim() === '') {
          throw new Error('EMPTY_RESPONSE: Webhook returned empty response. Nick may need to login again.');
        }
        
        // Try to parse JSON safely
        let raw;
        try {
          raw = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response text:', responseText.substring(0, 500));
          throw new Error('INVALID_JSON: Webhook returned invalid JSON. Response: ' + responseText.substring(0, 100));
        }
        
        console.log('Parsed response:', raw);

        let groups = [];
        
        // Handle n8n's nested { "response": { "body": [...] } } structure
        if (raw && raw.response && Array.isArray(raw.response.body)) {
          groups = raw.response.body.map(item => ({
            id: item.groupId || item.groupid || item.id || item.group_id,
            name: item.name || item.groupName || item.group_name || 'Không tên'
          }));
        }
        // Handle direct array format
        else if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ 
            id: i.groupId || i.groupid || i.id, 
            name: i.name || i.groupName || 'Không tên' 
          }));
        } 
        // Handle object with groups property
        else if (raw && raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => 
            typeof g === 'string' ? { id: g, name: g } : { 
              id: g.id || g.groupId, 
              name: g.name || g.groupName || g.id 
            }
          );
        }

        // Lưu kết quả vào cache
        setGroupCache(nick, groups);
        updateCacheDisplay(3, nick);

        if (groups.length === 0) {
          toggle(emptySourceMsg, true);
          toggle(emptyTargetMsg, true);
        } else {
          // Thêm các nhóm vào danh sách nguồn
          groups.forEach((g, index) => {
            sourceGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="source_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                  onchange="updateSourceGroupsCount()"
                >
                <label for="source_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
            
            // Thêm các nhóm vào danh sách đích
            targetGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="target_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateTargetGroupsCount()"
                >
                <label for="target_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
        }
        toggle(resultSection3, true);
        toggle(actionsBox3, true);
        updateSourceGroupsCount();
        updateTargetGroupsCount();
        
        // Hide overlay on success
        toggle(overlay, false);
      } catch (err) {
        console.error('Error during group scan (feature 3):', err);
        console.error('Error stack:', err.stack);
        
        // Use enhanced error handler with session expiry detection
        const { isSessionExpired, userMessage } = handleWebhookError(err, 'scan_groups_feature3', nick);
        
        // Show error overlay with appropriate message
        showErrorOverlay(userMessage, isSessionExpired);
        
      } finally {
        scanBtn3.disabled = false;
        toggle(spinner3, false);
        // Overlay will be hidden in success block or by showErrorOverlay in catch block
      }
    });
    
    // ---- FEATURE 3: Chuyển sang bước 2 ----
    nextBtn3.addEventListener('click', () => {
      if (sourceGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm nguồn.');
      if (targetGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm đích.');
      
      // Hiển thị thông tin nhóm nguồn và đích
      const sourceNames = sourceGroups.map(g => g.name).join(', ');
      const targetNames = targetGroups.map(g => g.name).join(', ');
      
      sourceGroupDisplay.textContent = `Nhóm nguồn: ${sourceNames}`;
      targetGroupDisplay.textContent = `Nhóm đích: ${targetNames}`;
      
      showFeature3Step(step3_2);
      members = [];
      memberCount.textContent = '0';
      invitedCount.textContent = '0';
      toggle(progressContainer, false);
      inviteBtn.disabled = true;
    });
    
    // ---- FEATURE 3: Quay lại bước 1 ----
    backBtn3.addEventListener('click', () => {
      showFeature3Step(step3_1);
    });
    
    // ---- FEATURE 3: Quét thành viên ----
    scanMembersBtn.addEventListener('click', async () => {
      const nick = nickSelect3.value;
      
      // Get the latest webhooks
      webhooks = getCurrentWebhooks();
      const currentScanMembersWebhook = webhooks.scanMembersWebhook;
      
      console.log('Scanning members with webhook:', currentScanMembersWebhook);
      
      // Validate webhook URL
      if (!currentScanMembersWebhook || currentScanMembersWebhook === '') {
        alert('WEBHOOK_NOT_CONFIGURED: Scan members webhook is not configured for this user. Please contact admin.');
        return;
      }
      
      scanMembersBtn.disabled = true;
      toggle(scanMembersSpinner, true);
      overlayText.innerHTML = 'Đang quét thành viên trong nhóm, vui lòng chờ...';
      toggle(overlay, true);
      
      try {
        members = [];
        let totalMembers = 0;
        
        // Quét thành viên từ các nhóm nguồn
        for (const group of sourceGroups) {
          overlayText.innerHTML = `Đang quét thành viên từ nhóm: ${group.name}...`;
          //  Gửi request đến webhook để quét thành viên
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 150000); // 2.5 minutes
          
          const res = await fetch(currentScanMembersWebhook, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nick, groupId: group.id }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!res.ok) throw new Error(`Lỗi khi quét nhóm ${group.name}`);
          
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) {
            // Lấy totalMembers và id_nick từ response
            const groupData = data[0];
            if (groupData.totalMembers) {
              const memberCountFromGroup = parseInt(groupData.totalMembers) || 0;
              totalMembers += memberCountFromGroup;
              memberCount.textContent = totalMembers;
              
              // Lưu id_nick để sử dụng khi mời thành viên
              if (groupData.id_nick) {
                currentIdNick = groupData.id_nick;
              }
              
              // Tạo danh sách thành viên giả lập để có thể mời
              for (let i = 0; i < memberCountFromGroup; i++) {
                members.push({
                  id: `member_${group.id}_${i}`,
                  name: `Thành viên ${i + 1}`,
                  groupId: group.id
                });
              }
            }
          }
        }
        
        showSuccessMessage(`Đã quét được ${totalMembers} thành viên!`);
        inviteBtn.disabled = false;
        
        // Nếu đã chọn tự động mời, tiến hành mời luôn
        if (autoInvite.checked && members.length > 0) {
          setTimeout(() => {
            inviteBtn.click();
          }, 1000);
        }
      } catch (err) {
        console.error(err);
        alert('Quét thành viên thất bại: ' + err.message);
      } finally {
        scanMembersBtn.disabled = false;
        toggle(scanMembersSpinner, false);
        toggle(overlay, false);
      }
    });
    
    // ---- FEATURE 3: Mời thành viên ----
    inviteBtn.addEventListener('click', async () => {
      if (members.length === 0) return alert('Chưa có thành viên nào được quét. Vui lòng quét thành viên trước.');
      
      const maxToInvite = parseInt(maxInvites.value) || 30;
      if (maxToInvite <= 0) return alert('Số lượng mời không hợp lệ.');
      
      const membersToInvite = members.slice(0, maxToInvite);
      const nick = nickSelect3.value;
      
      // Get the latest webhooks
      webhooks = getCurrentWebhooks();
      const currentInviteWebhook = webhooks.inviteWebhook;
      
      console.log('Inviting members with webhook:', currentInviteWebhook);
      
      // Validate webhook URL
      if (!currentInviteWebhook || currentInviteWebhook === '') {
        alert('WEBHOOK_NOT_CONFIGURED: Invite webhook is not configured for this user. Please contact admin.');
        return;
      }
      
      inviteBtn.disabled = true;
      toggle(inviteSpinner, true);
      toggle(progressContainer, true);
      
      let invitedSuccess = 0;
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      
      for (let i = 0; i < targetGroups.length; i++) {
        const targetGroup = targetGroups[i];
        overlayText.innerHTML = `Đang mời thành viên vào nhóm: ${targetGroup.name}...`;
        toggle(overlay, true);
        
        try {
          for (let j = 0; j < membersToInvite.length; j++) {
            const member = membersToInvite[j];
            const progress = Math.round(((i * membersToInvite.length + j + 1) / (targetGroups.length * membersToInvite.length)) * 100);
            
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            try {
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 60000); // 1 minute for individual invite
              
              const res = await fetch(currentInviteWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  nick,
                  groupId: targetGroup.id,
                  memberId: member.id,
                  memberName: member.name || 'Không tên',
                  id_nick: currentIdNick
                }),
                signal: controller.signal
              });
              
              clearTimeout(timeoutId);
              
              if (res.ok) {
                invitedSuccess++;
                invitedCount.textContent = invitedSuccess;
              }
              
              // Thêm delay để tránh bị khóa tài khoản
              await new Promise(resolve => setTimeout(resolve, 500));
            } catch (memberErr) {
              console.error(`Lỗi khi mời thành viên ${member.name || member.id}:`, memberErr);
              // Tiếp tục với thành viên tiếp theo
            }
          }
        } catch (groupErr) {
          console.error(`Lỗi khi mời thành viên vào nhóm ${targetGroup.name}:`, groupErr);
          alert(`Có lỗi xảy ra khi mời thành viên vào nhóm ${targetGroup.name}. Tiếp tục với nhóm tiếp theo.`);
        }
      }
      
      progressBar.style.width = '100%';
      progressText.textContent = '100%';
      
      showSuccessMessage(`Đã mời thành viên vào nhóm thành công, vui lòng kiểm tra trong Zalo!`);
      
      setTimeout(() => {
        toggle(overlay, false);
      }, 2000);
      
      inviteBtn.disabled = false;
      toggle(inviteSpinner, false);
    });

    // Khởi tạo ứng dụng
    checkAuth();
    
    // Đảm bảo các hàm cập nhật có thể truy cập global
    window.updateSelectedGroupsCount = updateSelectedGroupsCount;
    window.updateSourceGroupsCount = updateSourceGroupsCount;
    window.updateTargetGroupsCount = updateTargetGroupsCount;
    window.viewPostDetails = viewPostDetails;
    window.deleteScheduledPost = deleteScheduledPost;
    window.previewOldPost = previewOldPost;
    window.selectOldPost = selectOldPost;
    
    // Tạo bài mẫu để test (chỉ nếu chưa có bài nào)
    function createSamplePosts() {
      if (savedPosts.length === 0) {
        const samplePosts = [
          {
            id: Date.now() - 1000,
            content: "Dell inspiron 5420 like New ace ứng ib card em ak 0962 591 551\n- I5-1240P / 16gb / 512gb / 14ing 2.2K",
            images: [
              "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=",
              "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=",
              "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=",
              "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k="
            ],
            imageCount: 4,
            createdAt: new Date(Date.now() - 86400000).toISOString(),
            nick: "test"
          }
        ];
        
        savedPosts = samplePosts;
        localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
      }
    }

    // Khởi tạo các giá trị ban đầu
    updateCharCount();
    checkImageCount();
    checkPostImageCount();
    updateScheduledPostsList();
    updateOldPostCount();
    createSamplePosts();
    
    // Ẩn tất cả cache display khi load trang
    toggle(cacheInfo1, false);
    toggle(cacheInfo2, false);
    toggle(cacheInfo3, false);
    
    // Start countdown timer - update every minute
    setInterval(updateAllCountdowns, 60000); // 60 seconds
    
    // Kiểm tra elements quan trọng và khởi tạo event listener cho card "sử dụng bài cũ"
    if (ensureCriticalElementsExist()) {
      initializeUseOldPostCard();
    } else {
      console.error('Cannot initialize useOldPostCard due to missing critical elements');
    }
    
    // Đảm bảo state của tính năng "sử dụng bài cũ" được reset khi load trang (không cần gọi initializeUseOldPostCard lại vì đã gọi ở trên)
    console.log('Resetting old post feature state...');
    selectedOldPost = null;
    const useOldPostCard = $('useOldPostCard');
    if (useOldPostCard) {
      useOldPostCard.classList.remove('disabled');
      useOldPostCard.style.pointerEvents = '';
      useOldPostCard.style.opacity = '';
    }
    toggle($('oldPostModal'), false);
    toggle($('previewModal'), false);
    console.log('Old post feature state reset completed');
  </script>
</body>
</html>
